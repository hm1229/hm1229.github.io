<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>å®éªŒæ­¥éª¤ - rCore_Tutorial_Detail</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="lab0.html"><strong aria-hidden="true">1.</strong> å®éªŒé›¶ RV64 è£¸æœºåº”ç”¨</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="lab0-1.html"><strong aria-hidden="true">1.1.</strong> å®éªŒç›®çš„</a></li><li class="chapter-item expanded "><a href="lab0-2.html"><strong aria-hidden="true">1.2.</strong> çŸ¥è¯†å‚¨å¤‡</a></li><li class="chapter-item expanded "><a href="lab0-3.html"><strong aria-hidden="true">1.3.</strong> å®éªŒæ­¥éª¤</a></li><li class="chapter-item expanded "><a href="lab0-4.html"><strong aria-hidden="true">1.4.</strong> å°ç»“</a></li></ol></li><li class="chapter-item expanded "><a href="lab1.html"><strong aria-hidden="true">2.</strong> å®éªŒä¸€ ä¸­æ–­å¤„ç†</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="lab1-1.html"><strong aria-hidden="true">2.1.</strong> å®éªŒç›®çš„</a></li><li class="chapter-item expanded "><a href="lab1-2.html"><strong aria-hidden="true">2.2.</strong> çŸ¥è¯†å‚¨å¤‡</a></li><li class="chapter-item expanded "><a href="lab1-3.html"><strong aria-hidden="true">2.3.</strong> æ–¹æ³•è§£æ</a></li><li class="chapter-item expanded "><a href="lab1-4.html"><strong aria-hidden="true">2.4.</strong> å®éªŒæ­¥éª¤</a></li><li class="chapter-item expanded "><a href="lab1-5.html"><strong aria-hidden="true">2.5.</strong> å°ç»“</a></li></ol></li><li class="chapter-item expanded "><a href="lab2.html"><strong aria-hidden="true">3.</strong> å®éªŒäºŒ ç‰©ç†å†…å­˜</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="lab2-1.html"><strong aria-hidden="true">3.1.</strong> å®éªŒç›®çš„</a></li><li class="chapter-item expanded "><a href="lab2-2.html"><strong aria-hidden="true">3.2.</strong> çŸ¥è¯†å‚¨å¤‡</a></li><li class="chapter-item expanded "><a href="lab2-3.html"><strong aria-hidden="true">3.3.</strong> æ–¹æ¡ˆè§£æ</a></li><li class="chapter-item expanded "><a href="lab2-4.html"><strong aria-hidden="true">3.4.</strong> å®éªŒæ­¥éª¤</a></li><li class="chapter-item expanded "><a href="lab2-5.html"><strong aria-hidden="true">3.5.</strong> å°ç»“</a></li></ol></li><li class="chapter-item expanded "><a href="lab3.html"><strong aria-hidden="true">4.</strong> å®éªŒä¸‰ è™šæ‹Ÿå†…å­˜</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="lab3-1.html"><strong aria-hidden="true">4.1.</strong> å®éªŒç›®çš„</a></li><li class="chapter-item expanded "><a href="lab3-2.html"><strong aria-hidden="true">4.2.</strong> çŸ¥è¯†å‚¨å¤‡</a></li><li class="chapter-item expanded "><a href="lab3-3.html"><strong aria-hidden="true">4.3.</strong> æ–¹æ¡ˆè§£æ</a></li><li class="chapter-item expanded "><a href="lab3-4.html" class="active"><strong aria-hidden="true">4.4.</strong> å®éªŒæ­¥éª¤</a></li><li class="chapter-item expanded "><a href="lab3-5.html"><strong aria-hidden="true">4.5.</strong> å°ç»“</a></li></ol></li><li class="chapter-item expanded "><a href="lab4.html"><strong aria-hidden="true">5.</strong> å®éªŒå›› è¿›ç¨‹ä¸çº¿ç¨‹</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="lab4-1.html"><strong aria-hidden="true">5.1.</strong> å®éªŒåŸç†</a></li><li class="chapter-item expanded "><a href="lab4-2.html"><strong aria-hidden="true">5.2.</strong> æ–¹æ¡ˆè§£æ</a></li><li class="chapter-item expanded "><a href="lab4-3.html"><strong aria-hidden="true">5.3.</strong> åŸºç¡€çŸ¥è¯†</a></li><li class="chapter-item expanded "><a href="lab4-4.html"><strong aria-hidden="true">5.4.</strong> å®éªŒæ­¥éª¤</a></li></ol></li><li class="chapter-item expanded "><a href="lab5.html"><strong aria-hidden="true">6.</strong> å®éªŒäº” æ–‡ä»¶ç³»ç»Ÿ</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="lab5-1.html"><strong aria-hidden="true">6.1.</strong> å®éªŒå‚¨å¤‡</a></li><li class="chapter-item expanded "><a href="lab5-2.html"><strong aria-hidden="true">6.2.</strong> çŸ¥è¯†å‚¨å¤‡</a></li><li class="chapter-item expanded "><a href="lab5-3.html"><strong aria-hidden="true">6.3.</strong> æ–¹æ¡ˆè§£æ</a></li><li class="chapter-item expanded "><a href="lab5-4.html"><strong aria-hidden="true">6.4.</strong> å®éªŒæ­¥éª¤</a></li><li class="chapter-item expanded "><a href="lab5-5.html"><strong aria-hidden="true">6.5.</strong> å°ç»“</a></li></ol></li><li class="chapter-item expanded "><a href="lab6.html"><strong aria-hidden="true">7.</strong> å®éªŒå…­ ç”¨æˆ·è¿›ç¨‹</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="lab6-1.html"><strong aria-hidden="true">7.1.</strong> å®éªŒç›®çš„</a></li><li class="chapter-item expanded "><a href="lab6-2.html"><strong aria-hidden="true">7.2.</strong> çŸ¥è¯†å‚¨å¤‡</a></li><li class="chapter-item expanded "><a href="lab6-3.html"><strong aria-hidden="true">7.3.</strong> æ–¹æ¡ˆè§£æ</a></li><li class="chapter-item expanded "><a href="lab6-4.html"><strong aria-hidden="true">7.4.</strong> å®éªŒæ­¥éª¤</a></li><li class="chapter-item expanded "><a href="lab6-5.html"><strong aria-hidden="true">7.5.</strong> å°ç»“</a></li></ol></li><li class="chapter-item expanded "><a href="lab7.html"><strong aria-hidden="true">8.</strong> å®éªŒä¸ƒ æ€§èƒ½ç›‘æ§</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="lab7-1.html"><strong aria-hidden="true">8.1.</strong> å®éªŒç›®çš„</a></li><li class="chapter-item expanded "><a href="lab7-2.html"><strong aria-hidden="true">8.2.</strong> çŸ¥è¯†å‚¨å¤‡</a></li><li class="chapter-item expanded "><a href="lab7-3.html"><strong aria-hidden="true">8.3.</strong> æ–¹æ¡ˆè§£æ</a></li><li class="chapter-item expanded "><a href="lab7-4.html"><strong aria-hidden="true">8.4.</strong> å®éªŒæ­¥éª¤</a></li><li class="chapter-item expanded "><a href="lab7-5.html"><strong aria-hidden="true">8.5.</strong> å°ç»“</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">rCore_Tutorial_Detail</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="å®éªŒæ­¥éª¤"><a class="header" href="#å®éªŒæ­¥éª¤">å®éªŒæ­¥éª¤</a></h1>
<h3 id="ä¿®æ”¹å†…æ ¸"><a class="header" href="#ä¿®æ”¹å†…æ ¸">ä¿®æ”¹å†…æ ¸</a></h3>
<p>ä¹‹å‰çš„å†…æ ¸å®ç°å¹¶æœªä½¿èƒ½é¡µè¡¨æœºåˆ¶ï¼Œå®é™…ä¸Šå†…æ ¸æ˜¯ç›´æ¥åœ¨ç‰©ç†åœ°å€ç©ºé—´ä¸Šè¿è¡Œçš„ã€‚è¿™æ ·è™½ç„¶æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯ä¸ºäº†åç»­èƒ½å¤Ÿæ”¯æŒå¤šä¸ªç”¨æˆ·è¿›ç¨‹èƒ½å¤Ÿåœ¨å†…æ ¸ä¸­å¹¶å‘è¿è¡Œï¼Œæ»¡è¶³éš”ç¦»ç­‰æ€§è´¨ï¼Œæˆ‘ä»¬è¦å…ˆè¿ç”¨å­¦è¿‡çš„é¡µè¡¨çŸ¥è¯†ï¼ŒæŠŠå†…æ ¸çš„è¿è¡Œç¯å¢ƒä»ç‰©ç†åœ°å€ç©ºé—´è½¬ç§»åˆ°è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œä¸ºä¹‹åçš„åŠŸèƒ½æ‰“å¥½é“ºå«ã€‚</p>
<p>æ›´å…·ä½“çš„ï¼Œæˆ‘ä»¬ç°åœ¨æƒ³å°†å†…æ ¸ä»£ç æ”¾åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ä»¥ 0xffffffff80200000 å¼€å¤´çš„ä¸€æ®µé«˜åœ°å€ç©ºé—´ä¸­ã€‚è¿™æ„å‘³ç€åŸæ¥æ”¾åœ¨ 0x80200000 èµ·å§‹åœ°å€çš„å…¨éƒ¨å†…æ ¸ç»“æ„è¢«å¹³ç§»åˆ°äº† 0xffffffff80200000 çš„åœ°å€ä¸Šï¼Œå³æ˜ å°„å…³ç³»ä¸ºï¼šè™šæ‹Ÿåœ°å€å‡å»åç§»é‡ 0xffffffff00000000 ä¸ºåŸæ¥çš„ç‰©ç†åœ°å€ã€‚å½“ç„¶ï¼Œè¿™ç§çº¿æ€§å¹³ç§»å¹¶ä¸æ˜¯å”¯ä¸€çš„æ˜ å°„æ–¹å¼ï¼Œä½†æ˜¯è‡³å°‘ç°åœ¨ï¼Œå†…æ ¸çš„å…¨éƒ¨ä»£ç å’Œæ•°æ®æ‰€åœ¨çš„è™šæ‹Ÿç©ºé—´å’Œç‰©ç†ç©ºé—´æ˜¯è¿™æ ·çš„çº¿æ€§æ˜ å°„ã€‚</p>
<p>æ‰€ä»¥éœ€è¦æŠŠåŸæ¥çš„ linker script å’Œä¹‹å‰åœ¨ç‰©ç†å†…å­˜ç®¡ç†ä¸Šçš„ä¸€äº›å‚æ•°ä¿®æ”¹ä¸€ä¸‹ã€‚</p>
<pre><code class="language-clike">/* os/src/linker.ld 
/* Linker Script è¯­æ³•å¯ä»¥å‚è§ï¼šhttp://www.scoberlin.de/content/media/http/informatik/gcc_docs/ld_3.html */

/* ç›®æ ‡æ¶æ„ */
OUTPUT_ARCH(riscv)

/* æ‰§è¡Œå…¥å£ */
ENTRY(_start)

/* æ•°æ®å­˜æ”¾èµ·å§‹åœ°å€ */
BASE_ADDRESS = 0xffffffff80200000; /* ä¿®æ”¹ä¸ºè™šæ‹Ÿåœ°å€ */

SECTIONS
{
    /* . è¡¨ç¤ºå½“å‰åœ°å€ï¼ˆlocation counterï¼‰ */
    . = BASE_ADDRESS;

    /* start ç¬¦å·è¡¨ç¤ºå…¨éƒ¨çš„å¼€å§‹ä½ç½® */
    kernel_start = .;

    /* åŠ å…¥å¯¹é½ */
    . = ALIGN(4K);
    text_start = .;

    /* .text å­—æ®µ */
    .text : {
        /* æŠŠ entry å‡½æ•°æ”¾åœ¨æœ€å‰é¢ */
        *(.text.entry)
        /* è¦é“¾æ¥çš„æ–‡ä»¶çš„ .text å­—æ®µé›†ä¸­æ”¾åœ¨è¿™é‡Œ */
        *(.text .text.*)
    }

    /* åŠ å…¥å¯¹é½ */
    . = ALIGN(4K);
    rodata_start = .;

    /* .rodata å­—æ®µ */
    .rodata : {
        /* è¦é“¾æ¥çš„æ–‡ä»¶çš„ .rodata å­—æ®µé›†ä¸­æ”¾åœ¨è¿™é‡Œ */
        *(.rodata .rodata.*)
    }

    /* åŠ å…¥å¯¹é½ */
    . = ALIGN(4K);
    data_start = .;

    /* .data å­—æ®µ */
    .data : {
        /* è¦é“¾æ¥çš„æ–‡ä»¶çš„ .data å­—æ®µé›†ä¸­æ”¾åœ¨è¿™é‡Œ */
        *(.data .data.*)
    }

    /* åŠ å…¥å¯¹é½ */
    . = ALIGN(4K);
    bss_start = .;

    /* .bss å­—æ®µ */
    .bss : {
        /* è¦é“¾æ¥çš„æ–‡ä»¶çš„ .bss å­—æ®µé›†ä¸­æ”¾åœ¨è¿™é‡Œ */
        *(.sbss .bss .bss.*)
    }

    /* ç»“æŸåœ°å€ */
    /* åŠ å…¥å¯¹é½ */
    . = ALIGN(4K);
    kernel_end = .;
}
</code></pre>
<p>é¦–å…ˆï¼Œå¯¹äº linker scriptï¼Œæˆ‘ä»¬æŠŠæ”¾ç½®çš„åŸºåœ°å€ä¿®æ”¹ä¸ºäº†è™šæ‹Ÿåœ°å€ï¼Œå¦å¤–è¿˜æœ‰ä¸€äº›ä¿®æ”¹æ˜¯æˆ‘ä»¬æŠŠæ¯ä¸ªæ•°æ®æ®µéƒ½å¯¹é½åˆ°äº† 4KBï¼Œä¸€ä¸ª 4KB çš„è™šæ‹Ÿé¡µä¸­ä¸ä¼šåŒ…å«ä¸¤ä¸ªæ®µï¼Œè¿™æ„å‘³ç€è¿™ä¸ªé¡µçš„å±æ€§æ˜¯å¯ä»¥ç¡®å®šçš„ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä¸å¯¹é½çš„è¯ï¼Œåªè¯»çš„ .rodata å’Œ .data æ®µå¯èƒ½æ”¾åœ¨ä¸€ä¸ªé¡µä¸­ï¼Œä½†æ˜¯é¡µè¡¨ä¸­éœ€è¦å†™ä¸Šè¯¸å¦‚æ˜¯å¦å¯å†™çš„å±æ€§ï¼Œè¿™æ—¶å€™å°±å¿…é¡»åˆ†å¼€æ‰å¯ä»¥æ ‡æ³¨å±æ€§ã€‚</p>
<p>å’Œä¸Šä¸€ç« ç±»ä¼¼ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦å¯¹è™šæ‹Ÿåœ°å€å’Œè™šæ‹Ÿé¡µå·è¿™ä¸¤ä¸ªç±»è¿›è¡Œäº†å°è£…ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒäº†ä¸€äº›è¯¸å¦‚<code>VirtualAddress::from(PhysicalAddress)</code> çš„è½¬æ¢ traitï¼ˆå³ä¸€äº›åŠ å‡åç§»é‡ç­‰æ“ä½œï¼‰ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// os/src/memory/address.rs
//! å®šä¹‰åœ°å€ç±»å‹å’Œåœ°å€å¸¸é‡
//!
//! æˆ‘ä»¬ä¸ºè™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€åˆ†åˆ«è®¾ç«‹ç±»å‹ï¼Œåˆ©ç”¨ç¼–è¯‘å™¨æ£€æŸ¥æ¥é˜²æ­¢æ··æ·†ã€‚
//!
//! # ç±»å‹
//!
//! - è™šæ‹Ÿåœ°å€ [`VirtualAddress`]
//! - ç‰©ç†åœ°å€ [`PhysicalAddress`]
//! - è™šæ‹Ÿé¡µå· [`VirtualPageNumber`]
//! - ç‰©ç†é¡µå· [`PhysicalPageNumber`]
//!
//! å››ç§ç±»å‹å‡ç”±ä¸€ä¸ª `usize` æ¥è¡¨ç¤º
//!
//! # ç±»å‹è½¬æ¢
//!
//! ### ä¸åŸºæœ¬ç±»å‹çš„è½¬æ¢
//!
//! - å››ç§ç±»å‹å‡å®ç°äº† `From&lt;usize&gt;` å’Œ `Into&lt;usize&gt;`
//! - è™šæ‹Ÿåœ°å€å®ç°äº† `From&lt;*const T&gt;` å’Œ `From&lt;*mut T&gt;`ï¼Œå¯ä»¥ç”±ä¸€ä¸ªæŒ‡é’ˆç”Ÿæˆ
//!
//! ### è™šæ‹Ÿ â†’ è™šæ‹Ÿï¼Œç‰©ç† â†’ ç‰©ç†
//!
//! - é¡µå·è‡³åœ°å€ï¼šç›´æ¥ä¹˜ä»¥é¡µé¢å¤§å°
//! - åœ°å€è‡³é¡µå·ï¼šåº”å½“ä½¿ç”¨é¡µå·ç±»å‹çš„ [`floor`] å’Œ [`ceil`] é™æ€æ–¹æ³•æ¥è½¬æ¢
//!
//! [`floor`]: VirtualPageNumber::floor
//! [`ceil`]: VirtualPageNumber::ceil
//!
//! ### è™šæ‹Ÿ â†” ç‰©ç†
//!
//! - **åªèƒ½ç”¨äºçº¿æ€§æ˜ å°„**ï¼Œå¯ä»¥ä½¿ç”¨ `from` æˆ– `into` æ¥è½¬æ¢
//!
//! # å…¶ä»–æ–¹æ³•
//!
//! ### è™šæ‹Ÿåœ°å€ `VirtualAddress`
//!
//! ```rust
//! /// é€šè¿‡åœ°å€å¾—åˆ°ä»»ä½•ç±»å‹å˜é‡çš„å¼•ç”¨ã€‚æ²¡æœ‰ç±»å‹æ£€æŸ¥æ‰€ä»¥è¦æ ¼å¤–æ³¨æ„
//! pub fn deref&lt;T&gt;(self) -&gt; &amp;'static mut T { ... }
//! /// å¾—åˆ°å…¶é¡µå†…åç§»ï¼Œå³ä½ 12 ä½
//! pub fn page_offset(self) -&gt; usize { ... }
//! ```
//!
//! ### ç‰©ç†åœ°å€ `PhysicalAddress`
//!
//! ```rust
//! /// æŒ‰ç…§å†…æ ¸çº¿æ€§æ˜ å°„åï¼Œå¾—åˆ°å˜é‡å¼•ç”¨
//! pub fn deref_kernel&lt;T&gt;(self) -&gt; &amp;'static mut T { ... }
//! /// å¾—åˆ°å…¶é¡µå†…åç§»ï¼Œå³ä½ 12 ä½
//! pub fn page_offset(self) -&gt; usize { ... }
//! ```
//!
//! ### è™šæ‹Ÿé¡µå· `VirtualPageNumber`
//!
//! ```rust
//! /// é€šè¿‡åœ°å€å¾—åˆ°é¡µé¢æ‰€å¯¹åº”çš„ä¸€æ®µå†…å­˜
//! pub fn deref(self) -&gt; &amp;'static mut [u8; PAGE_SIZE] { ... }
//! /// å¾—åˆ°ä¸€è‡³ä¸‰çº§é¡µå·
//! pub fn levels(self) -&gt; [usize; 3] { ... }
//! ```
//!
//! ### ç‰©ç†é¡µå· `PhysicalPageNumber`
//!
//! ```rust
//! /// æŒ‰ç…§å†…æ ¸çº¿æ€§æ˜ å°„åå¾—åˆ°é¡µé¢å¯¹åº”çš„ä¸€æ®µå†…å­˜
//! pub fn deref_kernel(self) -&gt; &amp;'static mut [u8; PAGE_SIZE] { ... }
//! ```
//!
//! # åŸºæœ¬è¿ç®—
//!
//! - å››ç§ç±»å‹éƒ½å¯ä»¥ç›´æ¥ä¸ `usize` è¿›è¡ŒåŠ å‡ï¼Œè¿”å›ç»“æœä¸ºåŸæœ¬ç±»å‹
//! - å››ç§ç±»å‹éƒ½å¯ä»¥ä¸è‡ªå·±ç±»å‹è¿›è¡ŒåŠ å‡ï¼Œè¿”å›ç»“æœä¸º `usize`

use super::config::{KERNEL_MAP_OFFSET, PAGE_SIZE};
use bit_field::BitField;

/// è™šæ‹Ÿåœ°å€
#[repr(C)]
#[derive(Copy, Clone, Debug, Default, Eq, PartialEq, Ord, PartialOrd, Hash)]
pub struct VirtualAddress(pub usize);

/// ç‰©ç†åœ°å€
#[repr(C)]
#[derive(Copy, Clone, Debug, Default, Eq, PartialEq, Ord, PartialOrd, Hash)]
pub struct PhysicalAddress(pub usize);

/// è™šæ‹Ÿé¡µå·
#[repr(C)]
#[derive(Copy, Clone, Debug, Default, Eq, PartialEq, Ord, PartialOrd, Hash)]
pub struct VirtualPageNumber(pub usize);

/// ç‰©ç†é¡µå·
#[repr(C)]
#[derive(Copy, Clone, Debug, Default, Eq, PartialEq, Ord, PartialOrd, Hash)]
pub struct PhysicalPageNumber(pub usize);

/// è™šå®é¡µå·ä¹‹é—´çš„é¡µå·å·®
let Virtual_Physical_Page_Diff = KERNEL_MAP_OFFSET / PAGE_SIZE;

// ä»¥ä¸‹æ˜¯ä¸€å¤§å †ç±»å‹çš„ç›¸äº’è½¬æ¢ã€å„ç§çç¢æ“ä½œ
/// ä»æŒ‡é’ˆè½¬æ¢ä¸ºè™šæ‹Ÿåœ°å€
impl&lt;T&gt; From&lt;*const T&gt; for VirtualAddress {
    fn from(pointer: *const T) -&gt; Self {
        Self(pointer as usize)
    }
}
/// ä»æŒ‡é’ˆè½¬æ¢ä¸ºè™šæ‹Ÿåœ°å€
impl&lt;T&gt; From&lt;*mut T&gt; for VirtualAddress {
    fn from(pointer: *mut T) -&gt; Self {
        Self(pointer as usize)
    }
}

/// è™šå®é¡µå·ä¹‹é—´çš„çº¿æ€§æ˜ å°„
impl From&lt;PhysicalPageNumber&gt; for VirtualPageNumber {
    fn from(ppn: PhysicalPageNumber) -&gt; Self {
        Self(ppn.0 + Virtual_Physical_Page_Diff)
    }
}
/// è™šå®é¡µå·ä¹‹é—´çš„çº¿æ€§æ˜ å°„
impl From&lt;VirtualPageNumber&gt; for PhysicalPageNumber {
    fn from(virtual_page_number: VirtualPageNumber) -&gt; Self {
        Self(virtual_page_number.0 - Virtual_Physical_Page_Diff)
    }
}
/// è™šå®åœ°å€ä¹‹é—´çš„çº¿æ€§æ˜ å°„
impl From&lt;PhysicalAddress&gt; for VirtualAddress {
    fn from(pa: PhysicalAddress) -&gt; Self {
        Self(pa.0 + KERNEL_MAP_OFFSET)
    }
}
/// è™šå®åœ°å€ä¹‹é—´çš„çº¿æ€§æ˜ å°„
impl From&lt;VirtualAddress&gt; for PhysicalAddress {
    fn from(va: VirtualAddress) -&gt; Self {
        Self(va.0 - KERNEL_MAP_OFFSET)
    }
}
impl VirtualAddress {
    /// ä»è™šæ‹Ÿåœ°å€å–å¾—æŸç±»å‹çš„ &amp;mut å¼•ç”¨
    pub fn deref&lt;T&gt;(self) -&gt; &amp;'static mut T {
        unsafe { &amp;mut *(self.0 as *mut T) }
    }
    /// å–å¾—é¡µå†…åç§»
    pub fn page_offset(self) -&gt; usize {
        self.0 % PAGE_SIZE
    }
}

impl PhysicalAddress {
    /// ä»ç‰©ç†åœ°å€ç»è¿‡çº¿æ€§æ˜ å°„å–å¾— &amp;mut å¼•ç”¨
    pub fn deref_kernel&lt;T&gt;(self) -&gt; &amp;'static mut T {
        VirtualAddress::from(self).deref()
    }
    /// å–å¾—é¡µå†…åç§»
    pub fn page_offset(self) -&gt; usize {
        self.0 % PAGE_SIZE
    }
}
impl VirtualPageNumber {
    /// ä»è™šæ‹Ÿåœ°å€å–å¾—é¡µé¢
    pub fn deref(self) -&gt; &amp;'static mut [u8; PAGE_SIZE] {
        VirtualAddress::from(self).deref()
    }
}
impl PhysicalPageNumber {
    /// ä»ç‰©ç†åœ°å€ç»è¿‡çº¿æ€§æ˜ å°„å–å¾—é¡µé¢
    pub fn deref_kernel(self) -&gt; &amp;'static mut [u8; PAGE_SIZE] {
        PhysicalAddress::from(self).deref_kernel()
    }
}

macro_rules! implement_address_to_page_number {
    // è¿™é‡Œé¢çš„ç±»å‹è½¬æ¢å®ç° [`From`] traitï¼Œä¼šè‡ªåŠ¨å®ç°ç›¸åçš„ [`Into`] trait
    ($address_type: ty, $page_number_type: ty) =&gt; {
        impl From&lt;$page_number_type&gt; for $address_type {
            /// ä»é¡µå·è½¬æ¢ä¸ºåœ°å€
            fn from(page_number: $page_number_type) -&gt; Self {
                Self(page_number.0 * PAGE_SIZE)
            }
        }
        impl From&lt;$address_type&gt; for $page_number_type {
            /// ä»åœ°å€è½¬æ¢ä¸ºé¡µå·ï¼Œç›´æ¥è¿›è¡Œç§»ä½æ“ä½œ
            ///
            /// ä¸å…è®¸è½¬æ¢æ²¡æœ‰å¯¹é½çš„åœ°å€ï¼Œè¿™ç§æƒ…å†µåº”å½“ä½¿ç”¨ `floor()` å’Œ `ceil()`
            fn from(address: $address_type) -&gt; Self {
                assert!(address.0 % PAGE_SIZE == 0);
                Self(address.0 / PAGE_SIZE)
            }
        }
        impl $page_number_type {
            /// å°†åœ°å€è½¬æ¢ä¸ºé¡µå·ï¼Œå‘ä¸‹å–æ•´
            pub const fn floor(address: $address_type) -&gt; Self {
                Self(address.0 / PAGE_SIZE)
            }
            /// å°†åœ°å€è½¬æ¢ä¸ºé¡µå·ï¼Œå‘ä¸Šå–æ•´
            pub const fn ceil(address: $address_type) -&gt; Self {
                Self(address.0 / PAGE_SIZE + (address.0 % PAGE_SIZE != 0) as usize)
            }
        }
    };
}
implement_address_to_page_number! {PhysicalAddress, PhysicalPageNumber}
implement_address_to_page_number! {VirtualAddress, VirtualPageNumber}

// ä¸‹é¢è¿™äº›ä»¥åå¯èƒ½ä¼šåˆ æ‰ä¸€äº›

/// ä¸ºå„ç§ä»…åŒ…å«ä¸€ä¸ª usize çš„ç±»å‹å®ç°è¿ç®—æ“ä½œ
macro_rules! implement_usize_operations {
    ($type_name: ty) =&gt; {
        /// `+`
        impl core::ops::Add&lt;usize&gt; for $type_name {
            type Output = Self;
            fn add(self, other: usize) -&gt; Self::Output {
                Self(self.0 + other)
            }
        }
        /// `+=`
        impl core::ops::AddAssign&lt;usize&gt; for $type_name {
            fn add_assign(&amp;mut self, rhs: usize) {
                self.0 += rhs;
            }
        }
        /// `-`
        impl core::ops::Sub&lt;usize&gt; for $type_name {
            type Output = Self;
            fn sub(self, other: usize) -&gt; Self::Output {
                Self(self.0 - other)
            }
        }
        /// `-`
        impl core::ops::Sub&lt;$type_name&gt; for $type_name {
            type Output = usize;
            fn sub(self, other: $type_name) -&gt; Self::Output {
                self.0 - other.0
            }
        }
        /// `-=`
        impl core::ops::SubAssign&lt;usize&gt; for $type_name {
            fn sub_assign(&amp;mut self, rhs: usize) {
                self.0 -= rhs;
            }
        }
        /// å’Œ usize ç›¸äº’è½¬æ¢
        impl From&lt;usize&gt; for $type_name {
            fn from(value: usize) -&gt; Self {
                Self(value)
            }
        }
        /// å’Œ usize ç›¸äº’è½¬æ¢
        impl From&lt;$type_name&gt; for usize {
            fn from(value: $type_name) -&gt; Self {
                value.0
            }
        }
        impl $type_name {
            /// æ˜¯å¦æœ‰æ•ˆï¼ˆ0 ä¸ºæ— æ•ˆï¼‰
            pub fn valid(&amp;self) -&gt; bool {
                self.0 != 0
            }
        }
        /// {} è¾“å‡º
        impl core::fmt::Display for $type_name {
            fn fmt(&amp;self, f: &amp;mut core::fmt::Formatter&lt;'_&gt;) -&gt; core::fmt::Result {
                write!(f, &quot;{}(0x{:x})&quot;, stringify!($type_name), self.0)
            }
        }
    };
}
implement_usize_operations! {PhysicalAddress}
implement_usize_operations! {VirtualAddress}
implement_usize_operations! {PhysicalPageNumber}
implement_usize_operations! {VirtualPageNumber}
<span class="boring">}
</span></code></pre></pre>
<p>å¯¹åº”ä¿®æ”¹ <code>os/src/memory/config.rs</code> ä¸­çš„ <code>KERNEL_END_ADDRESS</code> ä¿®æ”¹ä¸ºè™šæ‹Ÿåœ°å€å¹¶åŠ å…¥åç§»é‡ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// os/src/memory/config.rs
lazy_static! {
    /// å†…æ ¸ä»£ç ç»“æŸçš„åœ°å€ï¼Œå³å¯ä»¥ç”¨æ¥åˆ†é…çš„å†…å­˜èµ·å§‹åœ°å€
    /// 
    /// å› ä¸º Rust è¯­è¨€é™åˆ¶ï¼Œæˆ‘ä»¬åªèƒ½å°†å…¶ä½œä¸ºä¸€ä¸ªè¿è¡Œæ—¶æ±‚å€¼çš„ static å˜é‡ï¼Œè€Œä¸èƒ½ä½œä¸º const
    pub static ref KERNEL_END_ADDRESS: VirtualAddress = VirtualAddress(kernel_end as usize); 
}

/// å†…æ ¸ä½¿ç”¨çº¿æ€§æ˜ å°„çš„åç§»é‡
pub const KERNEL_MAP_OFFSET: usize = 0xffff_ffff_0000_0000;
<span class="boring">}
</span></code></pre></pre>
<p>æœ€åä¸€æ­¥ï¼Œæˆ‘ä»¬éœ€è¦å‘Šè¯‰ RISC-V CPU æˆ‘ä»¬åšäº†è¿™äº›ä¿®æ”¹ï¼Œä¹Ÿå°±æ˜¯éœ€è¦åœ¨å¯åŠ¨æ—¶ã€åœ¨è¿›å…¥ <code>rust_main</code> ä¹‹å‰æˆ‘ä»¬è¦å®Œæˆä¸€ä¸ªä»ç‰©ç†åœ°å€è®¿å­˜æ¨¡å¼åˆ°è™šæ‹Ÿè®¿å­˜æ¨¡å¼çš„è½¬æ¢ï¼ŒåŒæ—¶è¿™ä¹Ÿæ„å‘³ç€ï¼Œæˆ‘ä»¬è¦å†™ä¸€ä¸ªç®€å•çš„é¡µè¡¨ï¼Œå®Œæˆè¿™ä¸ªçº¿æ€§æ˜ å°„ï¼š</p>
<pre><code class="language-assembly"># os/src/entry.asm
# æ“ä½œç³»ç»Ÿå¯åŠ¨æ—¶æ‰€éœ€çš„æŒ‡ä»¤ä»¥åŠå­—æ®µ
#
# æˆ‘ä»¬åœ¨ linker.ld ä¸­å°†ç¨‹åºå…¥å£è®¾ç½®ä¸ºäº† _startï¼Œå› æ­¤åœ¨è¿™é‡Œæˆ‘ä»¬å°†å¡«å……è¿™ä¸ªæ ‡ç­¾
# å®ƒå°†ä¼šæ‰§è¡Œä¸€äº›å¿…è¦æ“ä½œï¼Œç„¶åè·³è½¬è‡³æˆ‘ä»¬ç”¨ rust ç¼–å†™çš„å…¥å£å‡½æ•°
#
# å…³äº RISC-V ä¸‹çš„æ±‡ç¼–è¯­è¨€ï¼Œå¯ä»¥å‚è€ƒ https://github.com/riscv/riscv-asm-manual/blob/master/riscv-asm.md
# %hi è¡¨ç¤ºå– [12,32) ä½ï¼Œ%lo è¡¨ç¤ºå– [0,12) ä½

    .section .text.entry
    .globl _start
# ç›®å‰ _start çš„åŠŸèƒ½ï¼šå°†é¢„ç•™çš„æ ˆç©ºé—´å†™å…¥ $spï¼Œç„¶åè·³è½¬è‡³ rust_main
_start:
    # è®¡ç®— boot_page_table çš„ç‰©ç†é¡µå·
    lui t0, %hi(boot_page_table)
    li t1, 0xffffffff00000000
    sub t0, t0, t1
    srli t0, t0, 12
    # 1 &lt;&lt; 63 æ˜¯ satp ä¸­ä½¿ç”¨ Sv39 æ¨¡å¼çš„è®°å·, å°†modeæ¨¡å¼ç½®ä¸º1
    li t1, (1 &lt;&lt; 63)
    or t0, t0, t1
    # å†™å…¥ satp å¹¶æ›´æ–° TLB
    csrw satp, t0
    sfence.vma

    # åŠ è½½æ ˆåœ°å€
    lui sp, %hi(boot_stack_top)
    addi sp, sp, %lo(boot_stack_top)
    # è·³è½¬è‡³ rust_main
    lui t0, %hi(rust_main)
    addi t0, t0, %lo(rust_main)
    jr t0

    # å›å¿†ï¼šbss æ®µæ˜¯ ELF æ–‡ä»¶ä¸­åªè®°å½•é•¿åº¦ï¼Œè€Œå…¨éƒ¨åˆå§‹åŒ–ä¸º 0 çš„ä¸€æ®µå†…å­˜ç©ºé—´
    # è¿™é‡Œå£°æ˜å­—æ®µ .bss.stack ä½œä¸ºæ“ä½œç³»ç»Ÿå¯åŠ¨æ—¶çš„æ ˆ
    .section .bss.stack
    .global boot_stack
boot_stack:
    # 16K å¯åŠ¨æ ˆå¤§å°
    .space 4096 * 16
    .global boot_stack_top
boot_stack_top:
    # æ ˆç»“å°¾

    # åˆå§‹å†…æ ¸æ˜ å°„æ‰€ç”¨çš„é¡µè¡¨
    .section .data
    .align 12
boot_page_table:
    .quad 0
    .quad 0
    # ç¬¬ 2 é¡¹ï¼š0x8000_0000 -&gt; 0x8000_0000ï¼Œ0xcf è¡¨ç¤º VRWXAD å‡ä¸º 1
    .quad (0x80000 &lt;&lt; 10) | 0xcf
    .zero 507 * 8
    # ç¬¬ 510 é¡¹ï¼š0xffff_ffff_8000_0000 -&gt; 0x8000_0000ï¼Œ0xcf è¡¨ç¤º VRWXAD å‡ä¸º 1
    .quad (0x80000 &lt;&lt; 10) | 0xcf
    .quad 0
</code></pre>
<blockquote>
<h3 id="lui"><a class="header" href="#lui">lui</a></h3>
<p>lui rd, immediate 										x[rd] = sext(immediate[31:12] &lt;&lt; 12) </p>
<p>é«˜ä½ç«‹å³æ•°åŠ è½½ (Load Upper Immediate). U-type, RV32I and RV64I. å°†ç¬¦å·ä½æ‰©å±•çš„ 20 ä½ç«‹å³æ•° immediate å·¦ç§» 12 ä½ï¼Œå¹¶å°†ä½ 12 ä½ç½®é›¶ï¼Œå†™å…¥ x[rd]ä¸­ã€‚</p>
</blockquote>
<blockquote>
<h3 id="srli"><a class="header" href="#srli">srli</a></h3>
<p>srli rd, rs1, shamt 										x[rd] = (x[rs1] â‰« shamt) </p>
<p>ç«‹å³æ•°é€»è¾‘å³ç§»(Shift Right Logical Immediate). I-type, RV32I and RV64I. æŠŠå¯„å­˜å™¨x[rs1]å³ç§»shamtä½ï¼Œç©ºå‡ºçš„ä½ç½®å¡«å…¥0ï¼Œç»“æœå†™å…¥x[rd]ã€‚</p>
</blockquote>
<blockquote>
<h3 id="or"><a class="header" href="#or">or</a></h3>
<p>or rd, rs1, rs2					 							x[rd] = x[rs1] | ğ‘¥[ğ‘Ÿğ‘ 2] </p>
<p>å–æˆ–(OR). R-type, RV32I and RV64I. æŠŠå¯„å­˜å™¨ x[rs1]å’Œå¯„å­˜å™¨ x[rs2]æŒ‰ä½å–æˆ–ï¼Œç»“æœå†™å…¥ x[rd]ã€‚</p>
</blockquote>
<p>å›é¡¾ä¸€ä¸‹ï¼Œå½“ OpenSBI å¯åŠ¨å®Œæˆä¹‹åï¼Œæˆ‘ä»¬é¢å¯¹çš„æ˜¯ä¸€ä¸ªæ€æ ·çš„å±€é¢ï¼š</p>
<ul>
<li>ç‰©ç†å†…å­˜çŠ¶æ€ä¸­ OpenSBI ä»£ç æ”¾åœ¨ [0x80000000,0x80200000) ä¸­ï¼Œå†…æ ¸ä»£ç æ”¾åœ¨ä»¥ 0x80200000 å¼€å¤´çš„ä¸€å—è¿ç»­ç‰©ç†å†…å­˜ä¸­ï¼›</li>
<li>CPU çŠ¶æ€ï¼šå¤„äº S Mode ï¼Œå¯„å­˜å™¨ <code>satp</code> çš„ <code>MODE</code> å­—æ®µè¢«è®¾ç½®ä¸º <strong>Bare æ¨¡å¼</strong>ï¼Œå³æ— è®ºå–æŒ‡è¿˜æ˜¯è®¿å­˜æˆ‘ä»¬é€šè¿‡ç‰©ç†åœ°å€ç›´æ¥è®¿é—®ç‰©ç†å†…å­˜ã€‚PC å³ä¸º 0x80200000 æŒ‡å‘å†…æ ¸çš„ç¬¬ä¸€æ¡æŒ‡ä»¤ï¼›</li>
<li>æ ˆæŒ‡é’ˆå¯„å­˜å™¨ <code>sp</code> è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œè¿˜æ²¡æœ‰æŒ‡å‘ <code>boot_stack_top</code>ï¼›</li>
<li>ä»£ç ä¸­ <code>boot_stack_top</code> ç­‰ç¬¦å·çš„åœ°å€éƒ½æ˜¯è™šæ‹Ÿåœ°å€ï¼ˆé«˜åœ°å€ï¼‰ã€‚</li>
</ul>
<p>è€Œæˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯ï¼ŒæŠŠ CPU çš„è®¿é—®æ¨¡å¼æ”¹ä¸º Sv39ï¼Œè¿™é‡Œéœ€è¦åšçš„å°±æ˜¯æŠŠä¸€ä¸ªé¡µè¡¨çš„ç‰©ç†é¡µå·å’Œ Sv39 æ¨¡å¼å†™å…¥ <code>satp</code> å¯„å­˜å™¨ï¼Œç„¶ååˆ·æ–° TLBã€‚</p>
<p>æˆ‘ä»¬å…ˆä½¿ç”¨ä¸€ç§æœ€ç®€å•çš„é¡µè¡¨æ„é€ æ–¹æ³•ï¼Œè¿˜è®°å¾—ä¸Šä¸€èŠ‚ä¸­æ‰€è®²çš„å¤§é¡µå—ï¼Ÿé‚£æ—¶æˆ‘ä»¬æåˆ°ï¼Œå°†ä¸€ä¸ªä¸‰çº§é¡µè¡¨é¡¹çš„æ ‡å¿—ä½ <code>R,W,X</code> ä¸è®¾ä¸ºå…¨ 0ï¼Œå¯ä»¥å°†å®ƒå˜ä¸ºè¡¨ç¤º 1GB çš„ä¸€ä¸ªå¤§é¡µã€‚</p>
<p>é‚£ä¹ˆï¼Œé¡µè¡¨é‡Œé¢éœ€è¦æ”¾ä»€ä¹ˆæ•°æ®å‘¢ï¼Ÿç¬¬äºŒä¸ª <code>.quad</code> ï¼ˆè¡¨ä¸­ç¬¬ 510 é¡¹ï¼Œ510 çš„äºŒè¿›åˆ¶æ˜¯è¦ç´¢å¼•è™šæ‹Ÿåœ°å€çš„ <em>virtual_page_number</em>3ï¼‰æ˜¾ç„¶æ˜¯ä» 0xffffffff80000000 åˆ° 0x80000000 è¿™æ ·çš„çº¿æ€§æ˜ å°„ï¼ŒåŒæ—¶ <code>0xcf</code> è¡¨ç¤ºäº† <code>VRWXAD</code> å‡ä¸º 1 çš„å±æ€§ã€‚</p>
<p>åˆ·æ–°ä¹‹åï¼Œæˆ‘ä»¬åŠ è½½å®Œæ ˆåœ°å€ï¼Œå°±å¯ä»¥è·³è½¬åˆ° Rust ç¼–å†™çš„å‡½æ•°ä¸­äº†ã€‚è‡³æ­¤ï¼Œæˆ‘å¯ä»¥åœ¨ä¸»å‡½æ•°ä¸­åšäº›ç®€å•çš„è¾“å‡ºï¼Œæˆ‘ä»¬é‡æ–°ç¼–è¯‘ï¼ˆcargo ä¸ä¼šæ„ŸçŸ¥ linker script çš„å˜åŒ–ï¼Œå¯èƒ½éœ€è¦ <code>cargo clean</code>ï¼‰å¹¶è¿è¡Œï¼Œæ­£ç¡®çš„ç»“æœåº”è¯¥æ˜¯æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™äº›è¾“å‡ºï¼Œè™½ç„¶è¿™å’Œä¸Šä¸€ä¸ªç« èŠ‚çš„ç»“æœçœ‹ä¸Šå»æ²¡ä»€ä¹ˆä¸¤æ ·ï¼Œä½†æ˜¯ç°åœ¨å†…æ ¸çš„è¿è¡Œå·²ç»åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´äº†ã€‚</p>
<p>ä¸ºäº†å®ç° Sv39 é¡µè¡¨ï¼Œæˆ‘ä»¬çš„æ€è·¯æ˜¯æŠŠä¸€ä¸ªåˆ†é…å¥½çš„ç‰©ç†é¡µï¼ˆå³ä¼šè‡ªåŠ¨é”€æ¯çš„ <code>FrameTracker</code>ï¼‰æ‹¿æ¥æŠŠæ•°æ®å¡«å……ä½œä¸ºé¡µè¡¨ï¼Œè€Œé¡µè¡¨ä¸­çš„æ¯ä¸€é¡¹æ˜¯ä¸€ä¸ª 8 å­—èŠ‚çš„é¡µè¡¨é¡¹ã€‚</p>
<p>å¯¹äºé¡µè¡¨é¡¹çš„ä½çº§åˆ«çš„æ“ä½œï¼Œé¦–å…ˆéœ€è¦åŠ å…¥ä¸¤ä¸ªå…³äºä½æ“ä½œçš„ crateï¼š</p>
<pre><code class="language-toml"># os/Cargo.toml
[dependencies]
bitflags = &quot;1.2.1&quot;
bit_field = &quot;0.10.0&quot;
</code></pre>
<p>ç„¶åï¼Œé¦–å…ˆäº†æ„å»ºäº†é€šè¿‡è™šæ‹Ÿé¡µå·è·å¾—ä¸‰çº§ virtual_page_number çš„å‡½æ•°ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>//os/src/memory/address.rs
impl VirtualPageNumber {
    /// å¾—åˆ°ä¸€ã€äºŒã€ä¸‰çº§é¡µå·
    pub fn levels(self) -&gt; [usize; 3] {
        [
            self.0.get_bits(18..27),
            self.0.get_bits(9..18),
            self.0.get_bits(0..9),
        ]
    }
}
<span class="boring">}
</span></code></pre></pre>
<h4 id="é¡µè¡¨é¡¹"><a class="header" href="#é¡µè¡¨é¡¹">é¡µè¡¨é¡¹</a></h4>
<p>åé¢ï¼Œæˆ‘ä»¬æ¥å®ç°é¡µè¡¨é¡¹ï¼Œå…¶å®å°±æ˜¯å¯¹ä¸€ä¸ª <code>usize</code>ï¼ˆ8 å­—èŠ‚ï¼‰çš„å°è£…ï¼ŒåŒæ—¶æˆ‘ä»¬å¯ä»¥ç”¨åˆšåˆšåŠ å…¥çš„ bit çº§åˆ«æ“ä½œçš„ crate å¯¹å…¶å®ç°ä¸€äº›å–å‡ºç‰¹å®šæ®µçš„æ–¹ä¾¿åç»­å®ç°çš„å‡½æ•°ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// os/src/memory/mapping/page_table_entry.rs
//! é¡µè¡¨é¡¹ [`PageTableEntry`]
//!
//! # RISC-V 64 ä¸­çš„é¡µè¡¨é¡¹ç»“æ„
//! æ¯ä¸ªé¡µè¡¨é¡¹é•¿åº¦ä¸º 64 ä½ï¼Œæ¯ä¸ªé¡µé¢å¤§å°æ˜¯ 4KBï¼Œå³æ¯ä¸ªé¡µé¢èƒ½å­˜ä¸‹ 2^9=512 ä¸ªé¡µè¡¨é¡¹ã€‚
//! æ¯ä¸€ä¸ªé¡µè¡¨å­˜æ”¾ 512 ä¸ªé¡µè¡¨é¡¹ï¼Œè¯´æ˜æ¯ä¸€çº§é¡µè¡¨ä½¿ç”¨ 9 ä½æ¥æ ‡è®° virtual_page_numberã€‚
//!
//! # RISC-V 64 ä¸¤ç§é¡µè¡¨ç»„ç»‡æ–¹å¼ï¼šSv39 å’Œ Sv48
//! 64 ä½èƒ½å¤Ÿè¡¨ç¤ºçš„ç©ºé—´å¤§å°å¤ªå¤§äº†ï¼Œå› æ­¤ç°æœ‰çš„ 64 ä½ç¡¬ä»¶å®é™…ä¸Šéƒ½ä¸ä¼šæ”¯æŒ 64 ä½çš„åœ°å€ç©ºé—´ã€‚
//!
//! RISC-V 64 ç°æœ‰ä¸¤ç§åœ°å€é•¿åº¦ï¼š39 ä½å’Œ 48 ä½ï¼Œå…¶ä¸­ Sv39 çš„è™šæ‹Ÿåœ°å€å°±åŒ…æ‹¬ä¸‰çº§é¡µè¡¨å’Œé¡µå†…åç§»ã€‚
//! `3 * 9 + 12 = 39`
//!
//! æˆ‘ä»¬ä½¿ç”¨ Sv39ï¼ŒSv48 åŒç†ï¼Œåªæ˜¯å®ƒå…·æœ‰å››çº§é¡µè¡¨ã€‚

use crate::memory::address::*;
use bit_field::BitField;
use bitflags::*;

/// Sv39 ç»“æ„çš„é¡µè¡¨é¡¹
#[derive(Copy, Clone, Default)]
pub struct PageTableEntry(usize);

/// Sv39 é¡µè¡¨é¡¹ä¸­æ ‡å¿—ä½çš„ä½ç½®
const FLAG_RANGE: core::ops::Range&lt;usize&gt; = 0..8;
/// Sv39 é¡µè¡¨é¡¹ä¸­ç‰©ç†é¡µå·çš„ä½ç½®
const PAGE_NUMBER_RANGE: core::ops::Range&lt;usize&gt; = 10..54;

impl PageTableEntry {
    /// å°†ç›¸åº”é¡µå·å’Œæ ‡å¿—å†™å…¥ä¸€ä¸ªé¡µè¡¨é¡¹
    pub fn new(page_number: Option&lt;PhysicalPageNumber&gt;, mut flags: Flags) -&gt; Self {
        // æ ‡å¿—ä½ä¸­æ˜¯å¦åŒ…å« Valid å–å†³äº page_number æ˜¯å¦ä¸º Some
        // ä¸ºSomeæ·»åŠ validé¡¹
        // ä¸ºNoneåˆ é™¤validé¡¹
        flags.set(Flags::VALID, page_number.is_some());
        Self(
            *0usize
                .set_bits(FLAG_RANGE, flags.bits() as usize)
                .set_bits(PAGE_NUMBER_RANGE, page_number.unwrap_or_default().into()),   //è‹¥page_numberä¸ºNoneï¼Œé»˜è®¤ä¸º0
        )
    }
    /// è®¾ç½®ç‰©ç†é¡µå·ï¼ŒåŒæ—¶æ ¹æ® ppn æ˜¯å¦ä¸º Some æ¥è®¾ç½® Valid ä½
    pub fn update_page_number(&amp;mut self, ppn: Option&lt;PhysicalPageNumber&gt;) {
        if ppn.is_some() {
            self.0
                .set_bits(FLAG_RANGE, (self.flags() | Flags::VALID).bits() as usize)
                .set_bits(PAGE_NUMBER_RANGE, ppn.unwrap().into());
        } else {
            self.0
                .set_bits(FLAG_RANGE, (self.flags() - Flags::VALID).bits() as usize)
                .set_bits(PAGE_NUMBER_RANGE, 0);
        }
    }
    /// æ¸…é™¤
    pub fn clear(&amp;mut self) {
        self.0 = 0;
    }
    /// è·å–é¡µå·
    pub fn page_number(&amp;self) -&gt; PhysicalPageNumber {
        PhysicalPageNumber::from(self.0.get_bits(10..54))
    }
    /// è·å–åœ°å€
    pub fn address(&amp;self) -&gt; PhysicalAddress {
        PhysicalAddress::from(self.page_number())
    }
    /// è·å–æ ‡å¿—ä½
    pub fn flags(&amp;self) -&gt; Flags {
        unsafe { Flags::from_bits_unchecked(self.0.get_bits(..8) as u8) }
    }
    /// æ˜¯å¦ä¸ºç©ºï¼ˆå¯èƒ½éç©ºä¹Ÿé Validï¼‰
    pub fn is_empty(&amp;self) -&gt; bool {
        self.0 == 0
    }
    /// æ˜¯å¦æŒ‡å‘ä¸‹ä¸€çº§ï¼ˆRWX å…¨ä¸º0ï¼‰
    pub fn has_next_level(&amp;self) -&gt; bool {
        let flags = self.flags();
        !(flags.contains(Flags::READABLE)
            || flags.contains(Flags::WRITABLE)
            || flags.contains(Flags::EXECUTABLE))
    }
}

impl core::fmt::Debug for PageTableEntry {
    fn fmt(&amp;self, formatter: &amp;mut core::fmt::Formatter) -&gt; core::fmt::Result {
        formatter
            .debug_struct(&quot;PageTableEntry&quot;)
            .field(&quot;value&quot;, &amp;self.0)
            .field(&quot;page_number&quot;, &amp;self.page_number())
            .field(&quot;flags&quot;, &amp;self.flags())
            .finish()
    }
}

bitflags! {
    /// é¡µè¡¨é¡¹ä¸­çš„ 8 ä¸ªæ ‡å¿—ä½
    #[derive(Default)]
    pub struct Flags: u8 {
        /// æœ‰æ•ˆä½
        const VALID =       1 &lt;&lt; 0;
        /// å¯è¯»ä½
        const READABLE =    1 &lt;&lt; 1;
        /// å¯å†™ä½
        const WRITABLE =    1 &lt;&lt; 2;
        /// å¯æ‰§è¡Œä½
        const EXECUTABLE =  1 &lt;&lt; 3;
        /// ç”¨æˆ·ä½
        const USER =        1 &lt;&lt; 4;
        /// å…¨å±€ä½ï¼Œæˆ‘ä»¬ä¸ä¼šä½¿ç”¨
        const GLOBAL =      1 &lt;&lt; 5;
        /// å·²ä½¿ç”¨ä½ï¼Œç”¨äºæ›¿æ¢ç®—æ³•
        const ACCESSED =    1 &lt;&lt; 6;
        /// å·²ä¿®æ”¹ä½ï¼Œç”¨äºæ›¿æ¢ç®—æ³•
        const DIRTY =       1 &lt;&lt; 7;
    }
}

macro_rules! implement_flags {
    ($field: ident, $name: ident, $quote: literal) =&gt; {
        impl Flags {
            #[doc = &quot;è¿”å› `Flags::&quot;]
            #[doc = $quote]
            #[doc = &quot;` æˆ– `Flags::empty()`&quot;]
            pub fn $name(value: bool) -&gt; Flags {
                if value {
                    Flags::$field
                } else {
                    Flags::empty()
                }
            }
        }
    };
}
implement_flags! {USER, user, &quot;USER&quot;}
implement_flags! {READABLE, readable, &quot;READABLE&quot;}
implement_flags! {WRITABLE, writable, &quot;WRITABLE&quot;}
implement_flags! {EXECUTABLE, executable, &quot;EXECUTABLE&quot;}
<span class="boring">}
</span></code></pre></pre>
<blockquote>
<h3 id="bitflags"><a class="header" href="#bitflags">bitflags!</a></h3>
<p>è¿™ä¸ªå®äº§ç”Ÿä¸€ä¸ªå¯ä»¥ç®¡ç†ä¸€ç³»åˆ—æ ‡å¿—ï¼Œè¿™äº›æ ‡å¿—åªå¯ä»¥è¢«å®šä¹‰ä¸ºæ•´æ•°ç±»å‹.</p>
<p>set():æ ¹æ®ä¼ é€’å€¼æ’å…¥æˆ–åˆ é™¤æŒ‡å®šçš„æ ‡è®°ï¼ˆtrue æ’å…¥ false åˆ é™¤ï¼‰</p>
</blockquote>
<blockquote>
<h3 id="bit_fieldbitfield"><a class="header" href="#bit_fieldbitfield">bit_field::BitField</a></h3>
<p>set_bits(range, 0u8):ä»ä½åœ°å€ç«¯æ•°ï¼Œå°†rangeå†…çš„æ•°è®¾ç½®ä¸º0u8ã€‚</p>
</blockquote>
<blockquote>
<h3 id="unwrap"><a class="header" href="#unwrap">unwrap</a></h3>
<p>å¦‚æœ <code>Option</code> å€¼æ˜¯æˆå‘˜ <code>Some</code>ï¼Œ<code>unwrap</code> ä¼šè¿”å› <code>Some</code> ä¸­çš„å€¼ã€‚å¦‚æœ <code>Option</code> æ˜¯æˆå‘˜ <code>None</code>ï¼Œ<code>unwrap</code> ä¼šä¸ºæˆ‘ä»¬è°ƒç”¨ <code>panic!</code></p>
</blockquote>
<blockquote>
<h3 id="unwrap_or_default"><a class="header" href="#unwrap_or_default">unwrap_or_default()</a></h3>
<p>å¦‚æœ <code>Option</code> å€¼æ˜¯æˆå‘˜ <code>Some</code>ï¼Œ<code>unwrap</code> ä¼šè¿”å› <code>Some</code> ä¸­çš„å€¼ã€‚å¦‚æœ <code>Option</code> æ˜¯æˆå‘˜ <code>None</code>ï¼Œ<code>unwrap</code> ä¼šè¿”å›ç¼ºçœå€¼ <code>default()</code></p>
</blockquote>
<h4 id="é¡µè¡¨"><a class="header" href="#é¡µè¡¨">é¡µè¡¨</a></h4>
<p>æœ‰äº†é¡µè¡¨é¡¹ï¼Œ512 ä¸ªè¿ç»­çš„é¡µè¡¨é¡¹ç»„æˆçš„ 4KB ç‰©ç†é¡µï¼ŒåŒæ—¶å†åŠ ä¸Šä¸€äº›è¯¸å¦‚å¤šçº§æ·»åŠ æ˜ å°„çš„åŠŸèƒ½ï¼Œå°±å¯ä»¥å°è£…ä¸ºé¡µè¡¨ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// os/src/memory/mapping/page_table.rs
//! å•ä¸€é¡µè¡¨é¡µé¢ï¼ˆ4Kï¼‰ [`PageTable`]ï¼Œä»¥åŠç›¸åº”å°è£… [`FrameTracker`] çš„ [`PageTableTracker`]
//!
//! æ¯ä¸ªé¡µè¡¨ä¸­åŒ…å« 512 æ¡é¡µè¡¨é¡¹
//!
//! # é¡µè¡¨å·¥ä½œæ–¹å¼
//! 1.  é¦–å…ˆä» `satp` ä¸­è·å–é¡µè¡¨æ ¹èŠ‚ç‚¹çš„é¡µå·ï¼Œæ‰¾åˆ°æ ¹é¡µè¡¨
//! 2.  å¯¹äºè™šæ‹Ÿåœ°å€ä¸­æ¯ä¸€çº§ virtual_page_numberï¼ˆ9 ä½ï¼‰ï¼Œåœ¨å¯¹åº”çš„é¡µè¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„é¡µè¡¨é¡¹
//! 3.  å¦‚æœå¯¹åº”é¡¹ Valid ä½ä¸º 0ï¼Œåˆ™å‘ç”Ÿ Page Fault
//! 4.  å¦‚æœå¯¹åº”é¡¹ Readable / Writable ä½ä¸º 1ï¼Œåˆ™è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå¶å­èŠ‚ç‚¹ã€‚
//!     é¡µè¡¨é¡¹ä¸­çš„å€¼ä¾¿æ˜¯è™šæ‹Ÿåœ°å€å¯¹åº”çš„ç‰©ç†é¡µå·
//!     å¦‚æœæ­¤æ—¶è¿˜æ²¡æœ‰è¾¾åˆ°æœ€ä½çº§çš„é¡µè¡¨ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªå¤§é¡µ
//! 5.  å°†é¡µè¡¨é¡¹ä¸­çš„é¡µå·ä½œä¸ºä¸‹ä¸€çº§æŸ¥è¯¢ç›®æ ‡ï¼ŒæŸ¥è¯¢ç›´åˆ°è¾¾åˆ°æœ€ä½çº§çš„é¡µè¡¨ï¼Œæœ€ç»ˆå¾—åˆ°é¡µå·

use super::page_table_entry::PageTableEntry;
use crate::memory::{address::*, config::PAGE_SIZE, frame::FrameTracker};
/// å­˜æœ‰ 512 ä¸ªé¡µè¡¨é¡¹çš„é¡µè¡¨
///
/// æ³¨æ„æˆ‘ä»¬ä¸ä¼šä½¿ç”¨å¸¸è§„çš„ Rust è¯­æ³•æ¥åˆ›å»º `PageTable`ã€‚ç›¸åï¼Œæˆ‘ä»¬ä¼šåˆ†é…ä¸€ä¸ªç‰©ç†é¡µï¼Œ
/// å…¶å¯¹åº”äº†ä¸€æ®µç‰©ç†å†…å­˜ï¼Œç„¶åç›´æ¥æŠŠå…¶å½“åšé¡µè¡¨è¿›è¡Œè¯»å†™ã€‚æˆ‘ä»¬ä¼šåœ¨æ“ä½œç³»ç»Ÿä¸­ç”¨ä¸€ä¸ªã€ŒæŒ‡é’ˆã€
/// [`PageTableTracker`] æ¥è®°å½•è¿™ä¸ªé¡µè¡¨ã€‚
#[repr(C)]
pub struct PageTable {
    pub entries: [PageTableEntry; PAGE_SIZE / 8],
}

impl PageTable {
    /// å°†é¡µè¡¨æ¸…é›¶
    pub fn zero_init(&amp;mut self) {
        self.entries = [Default::default(); PAGE_SIZE / 8];
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>ç„¶è€Œï¼Œæˆ‘ä»¬ä¸ä¼šæŠŠè¿™ä¸ªå·¨å¤§çš„æ•°ç»„åœ¨å‡½æ•°ä¹‹é—´ä¸åœä¼ é€’ï¼Œæˆ‘ä»¬è¿™é‡Œçš„æ€è·¯ä¹ŸåŒæ ·æ›´å¤šåˆ©ç”¨ Rust çš„ç‰¹æ€§ï¼Œæ‰€ä»¥åšæ³•æ˜¯åˆ©ç”¨ä¸€ä¸ª <code>PageTableTracker</code> çš„ç»“æ„å¯¹ <code>FrameTracker</code> å°è£…ï¼Œä½†æ˜¯é‡Œé¢çš„è¡Œä¸ºæ˜¯å¯¹ <code>FrameTracker</code> è®°å½•çš„ç‰©ç†é¡µå½“æˆ <code>PageTable</code> è¿›è¡Œæ“ä½œã€‚åŒæ—¶ï¼Œè¿™ä¸ª <code>PageTableTracker</code> å’Œ <code>PageTableEntry</code> ä¹Ÿé€šè¿‡ä¸€äº› Rust ä¸­çš„è‡ªåŠ¨è§£å¼•ç”¨çš„ç‰¹æ€§ä¸ºåé¢çš„å®ç°é“ºå¹³äº†é“è·¯ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥ç›´æ¥æŠŠ <code>PageTableTracker</code> å½“æˆ <code>PageTable</code> å¯¹å¾…ï¼ŒåŒæ—¶ï¼Œå¦‚æœä¸€ä¸ª <code>PageTableEntry</code> æŒ‡å‘çš„æ˜¯å¦ä¸€ä¸ª <code>PageTable</code> æˆ‘ä»¬å¯ä»¥ç›´æ¥æ–¹ä¾¿çš„è®©ç¼–è¯‘å™¨è‡ªåŠ¨å®Œæˆè¿™äº›å·¥ä½œã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>//os/src/memory/mapping/page_table.rs
/// ç±»ä¼¼äº [`FrameTracker`]ï¼Œç”¨äºè®°å½•æŸä¸€ä¸ªå†…å­˜ä¸­é¡µè¡¨
///
/// æ³¨æ„åˆ°ï¼Œã€ŒçœŸæ­£çš„é¡µè¡¨ã€ä¼šæ”¾åœ¨æˆ‘ä»¬åˆ†é…å‡ºæ¥çš„ç‰©ç†é¡µå½“ä¸­ï¼Œè€Œä¸åº”æ”¾åœ¨æ“ä½œç³»ç»Ÿçš„è¿è¡Œæ ˆæˆ–å †ä¸­ã€‚
/// è€Œ `PageTableTracker` ä¼šä¿å­˜åœ¨æŸä¸ªçº¿ç¨‹çš„å…ƒæ•°æ®ä¸­ï¼ˆä¹Ÿå°±æ˜¯åœ¨æ“ä½œç³»ç»Ÿçš„å †ä¸Šï¼‰ï¼ŒæŒ‡å‘å…¶çœŸæ­£çš„é¡µè¡¨ã€‚
///
/// å½“ `PageTableTracker` è¢« drop æ—¶ï¼Œä¼šè‡ªåŠ¨ drop `FrameTracker`ï¼Œè¿›è€Œé‡Šæ”¾å¸§ã€‚
pub struct PageTableTracker(pub FrameTracker);

impl PageTableTracker {
    /// å°†ä¸€ä¸ªåˆ†é…çš„å¸§æ¸…é›¶ï¼Œå½¢æˆç©ºçš„é¡µè¡¨
    pub fn new(frame: FrameTracker) -&gt; Self {
        let mut page_table = Self(frame);
        page_table.zero_init();
        page_table
    }
    /// è·å–ç‰©ç†é¡µå·
    pub fn page_number(&amp;self) -&gt; PhysicalPageNumber {
        self.0.page_number()
    }
}

// PageTableEntry å’Œ PageTableTracker éƒ½å¯ä»¥ deref åˆ°å¯¹åº”çš„ PageTable
// ï¼ˆä½¿ç”¨çº¿æ€§æ˜ å°„æ¥è®¿é—®ç›¸åº”çš„ç‰©ç†åœ°å€ï¼‰

impl core::ops::Deref for PageTableTracker {
    type Target = PageTable;
    fn deref(&amp;self) -&gt; &amp;Self::Target {
        self.0.address().deref_kernel()
    }
}

impl core::ops::DerefMut for PageTableTracker {
    fn deref_mut(&amp;mut self) -&gt; &amp;mut Self::Target {
        self.0.address().deref_kernel()
    }
}

// å› ä¸º PageTableEntry å’Œå…·ä½“çš„ PageTable ä¹‹é—´æ²¡æœ‰ç”Ÿå‘½å‘¨æœŸå…³è”ï¼Œæ‰€ä»¥è¿”å› 'static å¼•ç”¨æ–¹ä¾¿å†™ä»£ç 
impl PageTableEntry {
    pub fn get_next_table(&amp;self) -&gt; &amp;'static mut PageTable {
        self.address().deref_kernel()
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å®Œæˆäº†ç‰©ç†é¡µä¸­çš„é¡µè¡¨ã€‚åé¢ï¼Œæˆ‘ä»¬å°†æŠŠå†…æ ¸ä¸­å„ä¸ªæ®µåšä¸€ä¸ªæ›´ç²¾ç»†çš„æ˜ å°„ï¼ŒæŠŠä¹‹å‰çš„é‚£ä¸ªç²—ç³™çš„åˆå§‹æ˜ å°„é¡µè¡¨æ›¿æ¢æ‰ã€‚</p>
<h3 id="å®ç°å†…æ ¸é‡æ˜ å°„"><a class="header" href="#å®ç°å†…æ ¸é‡æ˜ å°„">å®ç°å†…æ ¸é‡æ˜ å°„</a></h3>
<p>åœ¨ä¸Šæ–‡ä¸­ï¼Œæˆ‘ä»¬è™½ç„¶æ„é€ äº†ä¸€ä¸ªç®€å•æ˜ å°„ä½¿å¾—å†…æ ¸èƒ½å¤Ÿè¿è¡Œåœ¨è™šæ‹Ÿç©ºé—´ä¸Šï¼Œä½†æ˜¯è¿™ä¸ªæ˜ å°„æ˜¯æ¯”è¾ƒç²—ç³™çš„ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“ä¸€ä¸ªç¨‹åºé€šå¸¸å«æœ‰ä¸‹é¢å‡ æ®µï¼š</p>
<ul>
<li>.text æ®µï¼šå­˜æ”¾ä»£ç ï¼Œéœ€è¦å¯è¯»ã€å¯æ‰§è¡Œçš„ï¼Œä½†ä¸å¯å†™ï¼›</li>
<li>.rodata æ®µï¼šå­˜æ”¾åªè¯»æ•°æ®ï¼Œé¡¾åæ€ä¹‰ï¼Œéœ€è¦å¯è¯»ï¼Œä½†ä¸å¯å†™äº¦ä¸å¯æ‰§è¡Œï¼›</li>
<li>.data æ®µï¼šå­˜æ”¾ç»è¿‡åˆå§‹åŒ–çš„æ•°æ®ï¼Œéœ€è¦å¯è¯»ã€å¯å†™ï¼›</li>
<li>.bss æ®µï¼šå­˜æ”¾é›¶åˆå§‹åŒ–çš„æ•°æ®ï¼Œéœ€è¦å¯è¯»ã€å¯å†™ã€‚</li>
</ul>
<p>æˆ‘ä»¬çœ‹åˆ°å„ä¸ªæ®µä¹‹é—´çš„è®¿é—®æƒé™æ˜¯ä¸åŒçš„ã€‚åœ¨ç°åœ¨çš„æ˜ å°„ä¸‹ï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥ä¿®æ”¹å†…æ ¸ .text æ®µçš„ä»£ç ã€‚å› ä¸ºæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªæ ‡å¿—ä½ <code>W</code> ä¸º 1 çš„é¡µè¡¨é¡¹å®Œæˆæ˜ å°„ã€‚</p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬è€ƒè™‘å¯¹è¿™äº›æ®µåˆ†åˆ«è¿›è¡Œé‡æ˜ å°„ï¼Œä½¿å¾—ä»–ä»¬çš„è®¿é—®æƒé™è¢«æ­£ç¡®è®¾ç½®ã€‚</p>
<p>è¿™ä¸ªéœ€æ±‚å¯ä»¥æŠ½è±¡ä¸ºä¸€æ®µå†…å­˜ï¼ˆå¯èƒ½æ˜¯å¾ˆå¤šä¸ªè™šæ‹Ÿé¡µï¼‰é€šè¿‡ä¸€ä¸ªæ–¹å¼æ˜ å°„åˆ°å¾ˆå¤šä¸ªç‰©ç†é¡µä¸Šï¼ŒåŒæ—¶è¿™ä¸ªå†…å­˜æ®µå°†ä¼šæœ‰ä¸€ä¸ªç»Ÿä¸€çš„å±æ€§å’Œè¿›ä¸€æ­¥é«˜å±‚æ¬¡çš„ç®¡ç†ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨å†…æ ¸çš„ä»£ç æ®µä¸­ .bss æ®µå¯èƒ½ä¸æ­¢ä¼šå ç”¨ä¸€ä¸ªé¡µé¢ï¼Œè€Œæ˜¯å¾ˆå¤šé¡µé¢ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå…¨éƒ¨çš„è¿™äº›é¡µé¢ä»¥çº¿æ€§çš„å½¢å¼æ˜ å°„åˆ°ä¸€ä¸ªä½ç½®ã€‚åŒæ—¶æ•´ä¸ªè¿™äº›é¡µé¢æ„æˆçš„å†…å­˜æ®µå°†ä¼šæœ‰ç»Ÿä¸€çš„å±æ€§äº¤ç”±å†…æ ¸æ¥ç®¡ç†ã€‚</p>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥å°è£…å†…å­˜æ®µçš„æ¦‚å¿µã€‚</p>
<h4 id="å†…å­˜æ®µ-segment"><a class="header" href="#å†…å­˜æ®µ-segment">å†…å­˜æ®µ Segment</a></h4>
<p>æ­£å¦‚ä¸Šé¢è¯´çš„ï¼Œå†…å­˜æ®µæ˜¯ä¸€ç¯‡è¿ç»­çš„è™šæ‹Ÿé¡µèŒƒå›´ï¼Œå…¶ä¸­çš„æ¯ä¸€é¡µé€šè¿‡çº¿æ€§æ˜ å°„ï¼ˆç›´æ¥åç§»åˆ°ä¸€ä¸ªç‰©ç†é¡µï¼‰æˆ–è€…åˆ†é…ï¼ˆå…¶ä¸­çš„æ¯ä¸ªè™šæ‹Ÿé¡µè°ƒç”¨ç‰©ç†é¡µåˆ†é…å™¨åˆ†é…ä¸€ä¸ªç‰©ç†é¡µï¼‰ã€‚çº¿æ€§æ˜ å°„å‡ºç°åœ¨å†…æ ¸ç©ºé—´ä¸­ï¼›è€Œä¸ºäº†æ”¯æŒæ¯ä¸ªç”¨æˆ·è¿›ç¨‹çœ‹åˆ°çš„è™šæ‹Ÿç©ºé—´æ˜¯ä¸€æ ·çš„ï¼Œæˆ‘ä»¬ä¸èƒ½å…¨éƒ½ç”¨çº¿æ€§æ˜ å°„ï¼Œæ‰€ä»¥åŸºäºé¡µåˆ†é…çš„æ–¹å¼ä¼šå‡ºç°åœ¨ç”¨æˆ·è¿™ç§æƒ…æ™¯ä¸‹ã€‚å¦‚æœä½ è¿˜æ˜¯ä¸æ˜ç™½ï¼Œå¯ä»¥å»ç¿»çœ‹ä¸€ä¸‹æœ¬ç« çš„ã€Œè™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€ã€ä¸€ä¸ªå°èŠ‚ä¸­éæ•™å­¦ç‰ˆ rCore çš„æ˜ å°„å›¾ã€‚</p>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬ç”¨ enum å’Œ struct æ¥å°è£…å†…å­˜æ®µæ˜ å°„çš„ç±»å‹å’Œå†…å­˜æ®µæœ¬èº«ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// os/src/memory/mapping/segment.rs
//! æ˜ å°„ç±»å‹ [`MapType`] å’Œæ˜ å°„ç‰‡æ®µ [`Segment`]

use crate::memory::{address::*, mapping::Flags, range::Range};

/// æ˜ å°„çš„ç±»å‹
#[derive(Copy, Clone, Debug, Eq, PartialEq)]
pub enum MapType {
    /// çº¿æ€§æ˜ å°„ï¼Œæ“ä½œç³»ç»Ÿä½¿ç”¨
    Linear,
    /// æŒ‰å¸§åˆ†é…æ˜ å°„
    Framed,
}

/// ä¸€ä¸ªæ˜ å°„ç‰‡æ®µï¼ˆå¯¹åº”æ—§ tutorial çš„ `MemoryArea`ï¼‰
#[derive(Copy, Clone, Debug, Eq, PartialEq)]
pub struct Segment {
    /// æ˜ å°„ç±»å‹
    pub map_type: MapType,
    /// æ‰€æ˜ å°„çš„è™šæ‹Ÿåœ°å€
    pub range: Range&lt;VirtualAddress&gt;,
    /// æƒé™æ ‡å¿—
    pub flags: Flags,
}
<span class="boring">}
</span></code></pre></pre>
<p>åé¢ï¼Œä¸Šå±‚éœ€è¦åšçš„æ˜¯æŠŠä¸€ä¸ª Segment ä¸­æ²¡æœ‰å»ºç«‹ç‰©ç†é¡µæ˜ å°„å…³ç³»çš„å…¨éƒ¨è™šæ‹Ÿé¡µï¼Œéƒ½ç”³è¯·åˆ°ç‰©ç†é¡µå¹¶å»ºç«‹æ˜ å°„å…³ç³»ï¼ˆæˆ–è€…è¯´çº¿æ€§æ˜ å°„æ²¡æœ‰è¿™æ ·çš„è™šæ‹Ÿé¡µï¼Œè€Œåˆ†é…æ˜ å°„éœ€è¦æŠŠæ¯ä¸ªè™šæ‹Ÿé¡µéƒ½ç”³è¯·ä¸€ä¸ªå¯¹åº”çš„ç‰©ç†é¡µï¼‰ã€‚</p>
<p>äºæ˜¯æˆ‘ä»¬å¯ä»¥å®ç°è¿™æ ·ä¸€ä¸ªéœ€è¦å…·ä½“åˆ†é…çš„è¿­ä»£å™¨ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>//os/src/memory/mapping/segment.rs
impl Segment {
    /// éå†å¯¹åº”çš„ç‰©ç†åœ°å€ï¼ˆå¦‚æœå¯èƒ½ï¼‰
    pub fn iter_mapped(&amp;self) -&gt; Option&lt;impl Iterator&lt;Item = PhysicalPageNumber&gt;&gt; {
        match self.map_type {
            // çº¿æ€§æ˜ å°„å¯ä»¥ç›´æ¥å°†è™šæ‹Ÿåœ°å€è½¬æ¢
            MapType::Linear =&gt; Some(self.page_range().into().iter()),
            // æŒ‰å¸§æ˜ å°„æ— æ³•ç›´æ¥è·å¾—ç‰©ç†åœ°å€ï¼Œéœ€è¦åˆ†é…
            MapType::Framed =&gt; None,
        }
    }

    /// å°†åœ°å€ç›¸åº”åœ°ä¸Šä¸‹å–æ•´ï¼Œè·å¾—è™šæ‹Ÿé¡µå·åŒºé—´
    pub fn page_range(&amp;self) -&gt; Range&lt;VirtualPageNumber&gt; {
        Range::from(
            VirtualPageNumber::floor(self.range.start)..VirtualPageNumber::ceil(self.range.end),
        )
    }
}
<span class="boring">}
</span></code></pre></pre>
<h4 id="mapping"><a class="header" href="#mapping">Mapping</a></h4>
<p>æœ‰äº†é¡µè¡¨ã€å†…å­˜æ®µï¼Œæˆ‘ä»¬å¯¹è¿™ä¸¤ä¸ªè¿›è¡Œç»„åˆå’Œå°è£…ï¼Œå€ŸåŠ©å…¶ä¸­å¯¹é¡µè¡¨çš„æ“ä½œå®ç°å¯¹å†…å­˜æ®µçš„æ˜ å°„ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥è¯´è¿™é‡Œçš„ç»“æ„æ˜¯å¯¹ä¸Šä¸€å°èŠ‚çš„é¡µè¡¨çš„è¿›ä¸€æ­¥çš„ä»å•çº§åˆ°ä¸‰çº§çš„å°è£…ï¼Œéœ€è¦è®°å½•æ ¹é¡µè¡¨å’Œå¯¹å…¶ä¸­ç”³è¯·çš„é¡µè¡¨è¿›è¡Œè¿½è¸ªæ¥æ§åˆ¶ä½•æ—¶é‡Šæ”¾ç©ºé—´ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// os/src/memory/mapping/mapping.rs
//! Rv39 é¡µè¡¨çš„æ„å»º [`Mapping`]
//!
//! è®¸å¤šæ–¹æ³•è¿”å› [`Result`]ï¼Œå¦‚æœå‡ºç°é”™è¯¯ä¼šè¿”å› `Err(message)`ã€‚è®¾è®¡ç›®æ ‡æ˜¯ï¼Œæ­¤æ—¶å¦‚æœç»ˆæ­¢çº¿ç¨‹ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿåç»­é—®é¢˜ã€‚
//! ä½†æ˜¯å¦‚æœé”™è¯¯æ˜¯ç”±æ“ä½œç³»ç»Ÿä»£ç é€»è¾‘äº§ç”Ÿçš„ï¼Œåˆ™ä¼šç›´æ¥ panicã€‚

use crate::memory::{
    address::*,
    config::PAGE_SIZE,
    frame::{FrameTracker, FRAME_ALLOCATOR},
    mapping::{Flags, MapType, PageTable, PageTableEntry, PageTableTracker, Segment},
    MemoryResult,
};
use alloc::{collectentrieions::VecDeque, vec, vec::Vec};
use core::cmp::min;
use core::ptr::slice_from_raw_parts_mut;
#[derive(Default)]
/// æŸä¸ªçº¿ç¨‹çš„å†…å­˜æ˜ å°„å…³ç³»
pub struct Mapping {
    /// ä¿å­˜æ‰€æœ‰ä½¿ç”¨åˆ°çš„é¡µè¡¨
    page_tables: Vec&lt;PageTableTracker&gt;,
    /// æ ¹é¡µè¡¨çš„ç‰©ç†é¡µå·
    root_ppn: PhysicalPageNumber,
    /// æ‰€æœ‰åˆ†é…çš„ç‰©ç†é¡µé¢æ˜ å°„ä¿¡æ¯
    mapped_pairs: VecDeque&lt;(VirtualPageNumber, FrameTracker)&gt;,
}

impl Mapping {
    /// åˆ›å»ºä¸€ä¸ªæœ‰æ ¹èŠ‚ç‚¹çš„æ˜ å°„
    pub fn new() -&gt; MemoryResult&lt;Mapping&gt; {
        let root_table = PageTableTracker::new(FRAME_ALLOCATOR.lock().alloc()?);
        let root_ppn = root_table.page_number();
        Ok(Mapping {
            page_tables: vec![root_table],
            root_ppn,
            mapped_pairs: VecDeque::new(),
        })
    }
    
    /// æ‰¾åˆ°ç»™å®šè™šæ‹Ÿé¡µå·çš„ä¸‰çº§é¡µè¡¨é¡¹
    ///
    /// å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”çš„é¡µè¡¨é¡¹ï¼Œåˆ™ä¼šç›¸åº”åˆ›å»ºé¡µè¡¨
    pub fn find_entry(&amp;mut self, virtual_page_number: VirtualPageNumber) -&gt; MemoryResult&lt;&amp;mut PageTableEntry&gt; {
        // ä»æ ¹é¡µè¡¨å¼€å§‹å‘ä¸‹æŸ¥è¯¢
        // è¿™é‡Œä¸ç”¨ self.page_tables[0] é¿å…åé¢äº§ç”Ÿ borrow-check 
        let root_table: &amp;mut PageTable = PhysicalAddress::from(self.root_ppn).deref_kernel();
        let mut entry = &amp;mut root_table.entries[virtual_page_number.levels()[0]];
        for virtual_page_number_slice in &amp;virtual_page_number.levels()[1..] {
            if entry.is_empty() {
                // å¦‚æœé¡µè¡¨ä¸å­˜åœ¨ï¼Œåˆ™éœ€è¦åˆ†é…ä¸€ä¸ªæ–°çš„é¡µè¡¨
                let new_table = PageTableTracker::new(FRAME_ALLOCATOR.lock().alloc()?);
                let new_ppn = new_table.page_number();
                // å°†æ–°é¡µè¡¨çš„é¡µå·å†™å…¥å½“å‰çš„é¡µè¡¨é¡¹
                *entry = PageTableEntry::new(Some(new_ppn), Flags::VALID);
                // ä¿å­˜é¡µè¡¨
                self.page_tables.push(new_table);
            }
            // è¿›å…¥ä¸‹ä¸€çº§é¡µè¡¨ï¼ˆä½¿ç”¨åç§»é‡æ¥è®¿é—®ç‰©ç†åœ°å€ï¼‰
            entry = &amp;mut entry.get_next_table().entries[*virtual_page_number_slice];
        }
        // æ­¤æ—¶ entry ä½äºç¬¬ä¸‰çº§é¡µè¡¨
        Ok(entry)
    }

    /// ä¸ºç»™å®šçš„è™šæ‹Ÿ / ç‰©ç†é¡µå·å»ºç«‹æ˜ å°„å…³ç³»
    fn map_one(
        &amp;mut self,
        virtual_page_number: VirtualPageNumber,
        ppn: Option&lt;PhysicalPageNumber&gt;,
        flags: Flags,
    ) -&gt; MemoryResult&lt;()&gt; {
        // å®šä½åˆ°é¡µè¡¨é¡¹
        let entry = self.find_entry(virtual_page_number)?;
        assert!(entry.is_empty(), &quot;virtual address is already mapped&quot;);
        // é¡µè¡¨é¡¹ä¸ºç©ºï¼Œåˆ™å†™å…¥å†…å®¹
        *entry = PageTableEntry::new(ppn, flags);
        Ok(())
    }
    
    /// åŠ å…¥ä¸€æ®µæ˜ å°„ï¼Œå¯èƒ½ä¼šç›¸åº”åœ°åˆ†é…ç‰©ç†é¡µé¢
    ///
    /// æœªè¢«åˆ†é…ç‰©ç†é¡µé¢çš„è™šæ‹Ÿé¡µå·æš‚æ—¶ä¸ä¼šå†™å…¥é¡µè¡¨å½“ä¸­ï¼Œå®ƒä»¬ä¼šåœ¨å‘ç”Ÿ PageFault åå†å»ºç«‹é¡µè¡¨é¡¹ã€‚
    pub fn map(&amp;mut self, segment: &amp;Segment, init_data: Option&lt;&amp;[u8]&gt;) -&gt; MemoryResult&lt;()&gt; {
        match segment.map_type {
            // çº¿æ€§æ˜ å°„ï¼Œç›´æ¥å¯¹è™šæ‹Ÿåœ°å€è¿›è¡Œè½¬æ¢
            MapType::Linear =&gt; {
                for virtual_page_number in segment.page_range().iter() {
                    self.map_one(virtual_page_number, Some(virtual_page_number.into()), segment.flags)?;
                }
                // æ‹·è´æ•°æ®
                if let Some(data) = init_data {
                    unsafe {
                        (&amp;mut *slice_from_raw_parts_mut(segment.range.start.deref(), data.len()))
                            .copy_from_slice(data);				//å…è®¸æ‹·è´å¤šå…ƒç´ çš„æ•°æ®
                    }
                }
            }
            // éœ€è¦åˆ†é…å¸§è¿›è¡Œæ˜ å°„
            MapType::Framed =&gt; {
                for virtual_page_number in segment.page_range().iter() {
                    // é¡µé¢çš„æ•°æ®ï¼Œé»˜è®¤ä¸ºå…¨é›¶
                    let mut page_data = [0u8; PAGE_SIZE];
                    // å¦‚æœæä¾›äº†æ•°æ®ï¼Œåˆ™ä½¿ç”¨è¿™äº›æ•°æ®æ¥å¡«å…… page_data
                    if let Some(init_data) = init_data {
                        if !init_data.is_empty() {
                            // è¿™é‡Œå¿…é¡»è¿›è¡Œä¸€äº›è°ƒæ•´ï¼Œå› ä¸ºä¼ å…¥çš„æ•°æ®å¯èƒ½å¹¶éæŒ‰ç…§æ•´é¡µå¯¹é½

                            // æ‹·è´æ—¶å¿…é¡»è€ƒè™‘åŒºé—´ä¸æ•´é¡µä¸å¯¹é½çš„æƒ…å†µ
                            //    startï¼ˆä»…ç¬¬ä¸€é¡µæ—¶éé›¶ï¼‰
                            //      |        stopï¼ˆä»…æœ€åä¸€é¡µæ—¶éé›¶ï¼‰
                            // 0    |---data---|          4096
                            // |------------page------------|
                            let page_address = VirtualAddress::from(virtual_page_number);
                            let start = if segment.range.start &gt; page_address {
                                segment.range.start - page_address
                            } else {
                                0
                            };
                            let stop = min(PAGE_SIZE, segment.range.end - page_address);
                            // è®¡ç®—æ¥æºå’Œç›®æ ‡åŒºé—´å¹¶è¿›è¡Œæ‹·è´
                            let dst_slice = &amp;mut page_data[start..stop];    //ç›®æ ‡åŒºé—´
                            let src_slice = &amp;init_data[(page_address + start - segment.range.start)
                                ..(page_address + stop - segment.range.start)];	//æ¥æºåŒºé—´
                            dst_slice.copy_from_slice(src_slice);			//æ‹·è´
                        }
                    };

                    // å»ºç«‹æ˜ å°„
                    let mut frame = FRAME_ALLOCATOR.lock().alloc()?;
                    // æ›´æ–°é¡µè¡¨
                    self.map_one(virtual_page_number, Some(frame.page_number()), segment.flags)?;
                    // å†™å…¥æ•°æ®
                    (*frame).copy_from_slice(&amp;page_data);
                    // ä¿å­˜
                    self.mapped_pairs.push_back((virtual_page_number, frame));
                }
            }
        }
        Ok(())
    }
    /// ç§»é™¤ä¸€æ®µæ˜ å°„
    pub fn unmap(&amp;mut self, segment: &amp;Segment) {
        for virtual_page_number in segment.page_range().iter() {
            let entry = self.find_entry(virtual_page_number).unwrap();
            assert!(!entry.is_empty());
            // ä»é¡µè¡¨ä¸­æ¸…é™¤é¡¹
            entry.clear();
        }
        // ç§»é™¤ç›¸åº”çš„é¡µé¢
        self.mapped_pairs
            .retain(|(virtual_page_number, _)| !segment.page_range().contains(*virtual_page_number))
    }
    
    /// æŸ¥æ‰¾è™šæ‹Ÿåœ°å€å¯¹åº”çš„ç‰©ç†åœ°å€
    pub fn lookup(va: VirtualAddress) -&gt; Option&lt;PhysicalAddress&gt; {
        let mut current_ppn;
        unsafe {
            llvm_asm!(&quot;csrr $0, satp&quot; : &quot;=r&quot;(current_ppn) ::: &quot;volatile&quot;);
            current_ppn ^= 8 &lt;&lt; 60;
        }

        let root_table: &amp;PageTable =
            PhysicalAddress::from(PhysicalPageNumber(current_ppn)).deref_kernel();
        let vpn = VirtualPageNumber::floor(va);
        let mut entry = &amp;root_table.entries[vpn.levels()[0]];
        // ä¸ºäº†æ”¯æŒå¤§é¡µçš„æŸ¥æ‰¾ï¼Œæˆ‘ä»¬ç”¨ length è¡¨ç¤ºæŸ¥æ‰¾åˆ°çš„ç‰©ç†é¡µéœ€è¦åŠ å¤šå°‘ä½çš„åç§»
        let mut length = 12 + 2 * 9;
        for vpn_slice in &amp;vpn.levels()[1..] {
            if entry.is_empty() {
                return None;
            }
            if entry.has_next_level() {
                length -= 9;
                entry = &amp;mut entry.get_next_table().entries[*vpn_slice];
            } else {
                break;
            }
        }
        let base = PhysicalAddress::from(entry.page_number()).0;
        let offset = va.0 &amp; ((1 &lt;&lt; length) - 1);
        Some(PhysicalAddress(base + offset))
    }
}
<span class="boring">}
</span></code></pre></pre>
<ul>
<li><code>find_entry</code>å®ç°äº†å¯¹é¡µè¡¨çš„æŸ¥æ‰¾ï¼Œå¹¶åˆ©ç”¨è¯¥å‡½æ•°å®ç°å¯¹è™šæ‹Ÿé¡µå·åˆ°ç‰©ç†é¡µå·çš„æ˜ å°„</li>
<li><code>map_one</code> å®ç°äº†ä¸€ä¸ªè™šæ‹Ÿé¡µå¯¹ç‰©ç†é¡µçš„æ˜ å°„ï¼Œå› æ­¤æˆ‘ä»¬å°±å¯ä»¥å®ç°å¯¹ä¸€ä¸ªè¿ç»­çš„ Segment çš„æ˜ å°„</li>
<li><code>map</code>å®ç°äº†ä¸€ä¸ªæ–°çš„æ®µä¸ç‰©ç†é¡µçš„æ˜ å°„ï¼Œå¹¶æŠŠæ•°æ®æ‹·è´åˆ°ç›¸åº”çš„ç‰©ç†é¡µä¸­</li>
<li><code>unmap</code>å®ç°äº†å°†ä¸€æ®µæ˜ å°„ç§»é™¤çš„åŠŸèƒ½</li>
</ul>
<blockquote>
<h3 id="a-hrefhttpskaiserygithubiotrpl-zh-cnch09-02-recoverable-errors-with-resulthtmle4bca0e692ade99499e8afafe79a84e7ae80e58699-e8bf90e7ae97e7aca6ä¼ æ’­é”™è¯¯çš„ç®€å†™-è¿ç®—ç¬¦a"><a class="header" href="#a-hrefhttpskaiserygithubiotrpl-zh-cnch09-02-recoverable-errors-with-resulthtmle4bca0e692ade99499e8afafe79a84e7ae80e58699-e8bf90e7ae97e7aca6ä¼ æ’­é”™è¯¯çš„ç®€å†™-è¿ç®—ç¬¦a"><a href="https://kaisery.github.io/trpl-zh-cn/ch09-02-recoverable-errors-with-result.html#%E4%BC%A0%E6%92%AD%E9%94%99%E8%AF%AF%E7%9A%84%E7%AE%80%E5%86%99-%E8%BF%90%E7%AE%97%E7%AC%A6">ä¼ æ’­é”™è¯¯çš„ç®€å†™ï¼š<code>?</code> è¿ç®—ç¬¦</a></a></h3>
<p><code>Result</code> å€¼ä¹‹åçš„ <code>?</code> è¢«å®šä¹‰ä¸ºä¸ç¤ºä¾‹ä¸­å®šä¹‰çš„å¤„ç† <code>Result</code> å€¼çš„ <code>match</code> è¡¨è¾¾å¼æœ‰ç€å®Œå…¨ç›¸åŒçš„å·¥ä½œæ–¹å¼ã€‚å¦‚æœ <code>Result</code> çš„å€¼æ˜¯ <code>Ok</code>ï¼Œè¿™ä¸ªè¡¨è¾¾å¼å°†ä¼šè¿”å› <code>Ok</code> ä¸­çš„å€¼è€Œç¨‹åºå°†ç»§ç»­æ‰§è¡Œã€‚å¦‚æœå€¼æ˜¯ <code>Err</code>ï¼Œ<code>Err</code> ä¸­çš„å€¼å°†ä½œä¸ºæ•´ä¸ªå‡½æ•°çš„è¿”å›å€¼ï¼Œå°±å¥½åƒä½¿ç”¨äº† <code>return</code> å…³é”®å­—ä¸€æ ·ï¼Œè¿™æ ·é”™è¯¯å€¼å°±è¢«ä¼ æ’­ç»™äº†è°ƒç”¨è€…ã€‚</p>
<p>åœ¨ç¤ºä¾‹çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œ<code>File::open</code> è°ƒç”¨ç»“å°¾çš„ <code>?</code> å°†ä¼šæŠŠ <code>Ok</code> ä¸­çš„å€¼è¿”å›ç»™å˜é‡ <code>f</code>ã€‚å¦‚æœå‡ºç°äº†é”™è¯¯ï¼Œ<code>?</code> è¿ç®—ç¬¦ä¼šææ—©è¿”å›æ•´ä¸ªå‡½æ•°å¹¶å°†ä¸€äº› <code>Err</code> å€¼ä¼ æ’­ç»™è°ƒç”¨è€…ã€‚åŒç†ä¹Ÿé€‚ç”¨äº <code>read_to_string</code> è°ƒç”¨ç»“å°¾çš„ <code>?</code>ã€‚</p>
<p><code>?</code> è¿ç®—ç¬¦æ¶ˆé™¤äº†å¤§é‡æ ·æ¿ä»£ç å¹¶ä½¿å¾—å‡½æ•°çš„å®ç°æ›´ç®€å•	ã€‚æˆ‘ä»¬ç”šè‡³å¯ä»¥åœ¨ <code>?</code> ä¹‹åç›´æ¥ä½¿ç”¨é“¾å¼æ–¹æ³•è°ƒç”¨æ¥è¿›ä¸€æ­¥ç¼©çŸ­ä»£ç ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use std::io;
use std::io::Read;
use std::fs::File;

fn read_username_from_file() -&gt; Result&lt;String, io::Error&gt; {
let mut f = File::open(&quot;hello.txt&quot;)?;
let mut s = String::new();
f.read_to_string(&amp;mut s)?;
Ok(s)
}
<span class="boring">}
</span></code></pre></pre>
</blockquote>
<blockquote>
<h3 id="vec-å®"><a class="header" href="#vec-å®"><code>vec!</code> å®</a></h3>
<p><code>vec!</code> å®å¯ç”¨æ¥åˆå§‹åŒ–ä¸€ä¸ª vector åŠ¨æ€æ•°ç»„</p>
</blockquote>
<blockquote>
<p><strong>Rustè¯­æ³•å¡ç‰‡ï¼šäº’æ–¥å™¨  <code>Mutex</code></strong></p>
<p><strong>äº’æ–¥å™¨</strong> <em>mutex</em>æ˜¯ <em>mutual exclusion</em> çš„ç¼©å†™ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä»»æ„æ—¶åˆ»ï¼Œå…¶åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®æŸäº›æ•°æ®ã€‚ä¸ºäº†è®¿é—®äº’æ–¥å™¨ä¸­çš„æ•°æ®ï¼Œçº¿ç¨‹é¦–å…ˆéœ€è¦é€šè¿‡è·å–äº’æ–¥å™¨çš„ <strong>é”</strong>ï¼ˆ<em>lock</em>ï¼‰æ¥è¡¨æ˜å…¶å¸Œæœ›è®¿é—®æ•°æ®ã€‚é”æ˜¯ä¸€ä¸ªä½œä¸ºäº’æ–¥å™¨ä¸€éƒ¨åˆ†çš„æ•°æ®ç»“æ„ï¼Œå®ƒè®°å½•è°æœ‰æ•°æ®çš„æ’ä»–è®¿é—®æƒã€‚å› æ­¤ï¼Œæˆ‘ä»¬æè¿°äº’æ–¥å™¨ä¸ºé€šè¿‡é”ç³»ç»Ÿ <strong>ä¿æŠ¤</strong>ï¼ˆ<em>guarding</em>ï¼‰å…¶æ•°æ®ã€‚</p>
<p><a href="https://kaisery.github.io/trpl-zh-cn/ch16-03-shared-state.html">äº’æ–¥å™¨ <code>Mutex</code> è¯¦ç»†ä¿¡æ¯</a></p>
</blockquote>
<p>ä¿®æ”¹frame_tracker.rs</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// os/src/memory/frame/frame_tracker.rs
/// æä¾›ç‰©ç†é¡µçš„ã€Œ`Box`ã€ [`FrameTracker`]

use crate::memory::{address::*, FRAME_ALLOCATOR, PAGE_SIZE};

/// åˆ†é…å‡ºçš„ç‰©ç†é¡µ
///
/// # `Tracker` æ˜¯ä»€ä¹ˆï¼Ÿ
/// å¤ªé•¿ä¸çœ‹
/// &gt; å¯ä»¥ç†è§£ä¸º [`Box`](alloc::boxed::Box)ï¼Œè€ŒåŒºåˆ«åœ¨äºï¼Œå…¶ç©ºé—´ä¸æ˜¯åˆ†é…åœ¨å †ä¸Šï¼Œ
/// &gt; è€Œæ˜¯ç›´æ¥åœ¨å†…å­˜ä¸­åˆ’ä¸€ç‰‡ï¼ˆä¸€ä¸ªç‰©ç†é¡µï¼‰ã€‚
///
/// åœ¨æˆ‘ä»¬å®ç°æ“ä½œç³»ç»Ÿçš„è¿‡ç¨‹ä¸­ï¼Œä¼šç»å¸¸é‡åˆ°ã€ŒæŒ‡å®šä¸€å—å†…å­˜åŒºåŸŸä½œä¸ºæŸç§ç”¨å¤„ã€çš„æƒ…å†µã€‚
/// æ­¤æ—¶ï¼Œæˆ‘ä»¬è¯´è¿™å—å†…å­˜å¯ä»¥ç”¨ï¼Œä½†æ˜¯å› ä¸ºå®ƒä¸åœ¨å †æ ˆä¸Šï¼ŒRust ç¼–è¯‘å™¨å¹¶ä¸çŸ¥é“å®ƒæ˜¯ä»€ä¹ˆï¼Œæ‰€ä»¥
/// æˆ‘ä»¬éœ€è¦ unsafe åœ°å°†å…¶è½¬æ¢ä¸º `&amp;'static mut T` çš„å½¢å¼ï¼ˆ`'static` ä¸€èˆ¬å¯ä»¥çœç•¥ï¼‰ã€‚
///
/// ä½†æ˜¯ï¼Œæ¯”å¦‚æˆ‘ä»¬ç”¨ä¸€å—å†…å­˜æ¥ä½œä¸ºé¡µè¡¨ï¼Œè€Œå½“è¿™ä¸ªé¡µè¡¨æˆ‘ä»¬ä¸å†éœ€è¦çš„æ—¶å€™ï¼Œå°±åº”å½“é‡Šæ”¾ç©ºé—´ã€‚
/// æˆ‘ä»¬å…¶å®æ›´éœ€è¦ä¸€ä¸ªåƒã€Œåˆ›å»ºä¸€ä¸ªæœ‰ç”Ÿå‘½æœŸçš„å¯¹è±¡ã€ä¸€æ ·çš„æ¨¡å¼æ¥ä½¿ç”¨è¿™å—å†…å­˜ã€‚å› æ­¤ï¼Œ
/// æˆ‘ä»¬ä¸å¦¨ç”¨ `Tracker` ç±»å‹æ¥å°è£…è¿™æ ·ä¸€ä¸ª `&amp;'static mut` å¼•ç”¨ã€‚
///
/// ä½¿ç”¨ `Tracker` å…¶å®å°±å¾ˆåƒä½¿ç”¨ä¸€ä¸ª smart pointerã€‚å¦‚æœéœ€è¦å¼•ç”¨è®¡æ•°ï¼Œ
/// å°±åœ¨å¤–é¢å†å¥—ä¸€å±‚ [`Arc`](alloc::sync::Arc) å°±å¥½
pub struct FrameTracker(pub(super) PhysicalPageNumber);

impl FrameTracker {
    /// å¸§çš„ç‰©ç†åœ°å€
    pub fn address(&amp;self) -&gt; PhysicalAddress {
        self.0.into()
    }
    /// å¸§çš„ç‰©ç†é¡µå·
    pub fn page_number(&amp;self) -&gt; PhysicalPageNumber {
        self.0
    }
}

/// `FrameTracker` å¯ä»¥ deref å¾—åˆ°å¯¹åº”çš„ `[u8; PAGE_SIZE]`
impl core::ops::Deref for FrameTracker {
    type Target = [u8; PAGE_SIZE];
    fn deref(&amp;self) -&gt; &amp;Self::Target {
        self.page_number().deref_kernel()
    }
}

/// `FrameTracker` å¯ä»¥ deref å¾—åˆ°å¯¹åº”çš„ `[u8; PAGE_SIZE]`
impl core::ops::DerefMut for FrameTracker {
    fn deref_mut(&amp;mut self) -&gt; &amp;mut Self::Target {
        self.page_number().deref_kernel()
    }
}


/// å¸§åœ¨é‡Šæ”¾æ—¶ä¼šæ”¾å› [`static@FRAME_ALLOCATOR`] çš„ç©ºé—²é“¾è¡¨ä¸­
impl Drop for FrameTracker {
    fn drop(&amp;mut self) {
        FRAME_ALLOCATOR.lock().dealloc(self);
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>æœ€åï¼Œæˆ‘ä»¬å®ç°ä¸€ä¸ªå‡½æ•°å®ç°é¡µè¡¨çš„æ¿€æ´»ï¼Œä¹Ÿå°±æ˜¯æŠŠ <code>satp</code> å¯„å­˜å™¨æ›´æ–°å¹¶åˆ·æ–° TLBï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>//os/src/memory/mapping/mapping.rs   impl Mapping:
/// å°†å½“å‰çš„æ˜ å°„åŠ è½½åˆ° `satp` å¯„å­˜å™¨
pub fn activate(&amp;self) {
    // satp ä½ 27 ä½ä¸ºé¡µå·ï¼Œé«˜ 4 ä½ä¸ºæ¨¡å¼ï¼Œ0b1000 è¡¨ç¤º Sv39
    let new_satp = self.root_ppn.0 | (1 &lt;&lt; 63);
    unsafe {
        // å°† new_satp çš„å€¼å†™åˆ° satp å¯„å­˜å™¨
        llvm_asm!(&quot;csrw satp, $0&quot; :: &quot;r&quot;(new_satp) :: &quot;volatile&quot;);
        // åˆ·æ–° TLB
        llvm_asm!(&quot;sfence.vma&quot; :::: &quot;volatile&quot;);
    }
}
<span class="boring">}
</span></code></pre></pre>
<blockquote>
<h3 id="sfencevma"><a class="header" href="#sfencevma"><code>sfence.vma</code></a></h3>
<p>è¿™æ¡ <code>sfence.vma </code>ä¼šé€šçŸ¥å¤„ç†å™¨ï¼Œè½¯ä»¶å¯èƒ½å·²ç»ä¿®æ”¹äº†é¡µè¡¨ï¼Œäºæ˜¯å¤„ç†å™¨å¯ä»¥ ç›¸åº”åœ°åˆ·æ–°è½¬æ¢ç¼“å­˜ã€‚å®ƒéœ€è¦ä¸¤ä¸ªå¯é€‰çš„å‚æ•°ï¼Œè¿™æ ·å¯ä»¥ç¼©å°ç¼“å­˜åˆ·æ–°çš„èŒƒå›´ã€‚ä¸€ä¸ªä½äº rs1ï¼Œå®ƒæŒ‡ç¤ºäº†é¡µè¡¨å“ªä¸ªè™šå€å¯¹åº”çš„è½¬æ¢è¢«ä¿®æ”¹äº†;å¦ä¸€ä¸ªä½äº rs2ï¼Œå®ƒç»™å‡ºäº†è¢«ä¿®æ”¹é¡µè¡¨ çš„è¿›ç¨‹çš„åœ°å€ç©ºé—´æ ‡è¯†ç¬¦(ASID)ã€‚å¦‚æœä¸¤è€…éƒ½æ˜¯ x0ï¼Œä¾¿ä¼šåˆ·æ–°æ•´ä¸ªè½¬æ¢ç¼“å­˜ã€‚</p>
</blockquote>
<h4 id="memoryset"><a class="header" href="#memoryset">MemorySet</a></h4>
<p>æœ€åï¼Œæˆ‘ä»¬éœ€è¦æŠŠå†…æ ¸çš„æ¯ä¸ªæ®µæ ¹æ®ä¸åŒçš„å±æ€§å†™å…¥ä¸Šé¢çš„å°è£…çš„ <code>Mapping</code> ä¸­ï¼Œå¹¶æŠŠå®ƒä½œä¸ºä¸€ä¸ªæ–°çš„ç»“æ„ <code>MemorySet</code> ç»™åé¢çš„çº¿ç¨‹çš„æ¦‚å¿µä½¿ç”¨ï¼Œè¿™æ„å‘³ç€ï¼šæ¯ä¸ªçº¿ç¨‹ï¼ˆåˆ°ç›®å‰ä¸ºæ­¢ä½ å¯ä»¥å¤§è‡´ç†è§£ä¸ºè‡ªå·±ç”µè„‘ä¸­çš„åŒæ—¶å·¥ä½œçš„åº”ç”¨ç¨‹åºä»¬ï¼‰å°†ä¼šæ‹¥æœ‰ä¸€ä¸ª <code>MemorySet</code>ï¼Œå…¶ä¸­å­˜çš„å°†ä¼šæ˜¯ã€Œå®ƒçœ‹åˆ°çš„è™šæ‹Ÿå†…å­˜ç©ºé—´åˆ†æˆçš„å†…å­˜æ®µã€å’Œã€Œè¿™äº›æ®µä¸­åŒ…å«çš„è™šæ‹Ÿé¡µåˆ°ç‰©ç†é¡µçš„æ˜ å°„ã€ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// os/src/memory/mapping/memory_set.rs
//! ä¸€ä¸ªçº¿ç¨‹ä¸­å…³äºå†…å­˜ç©ºé—´çš„æ‰€æœ‰ä¿¡æ¯ [`MemorySet`]
//!

use crate::memory::{
    address::*,
    config::*,
    mapping::{Flags, MapType, Mapping, Segment},
    range::Range,
    MemoryResult,
};
use alloc::{vec, vec::Vec};

/// ä¸€ä¸ªè¿›ç¨‹æ‰€æœ‰å…³äºå†…å­˜ç©ºé—´ç®¡ç†çš„ä¿¡æ¯
pub struct MemorySet {
    /// ç»´æŠ¤é¡µè¡¨å’Œæ˜ å°„å…³ç³»
    pub mapping: Mapping,
    /// æ¯ä¸ªå­—æ®µ
    pub segments: Vec&lt;Segment&gt;,
}
<span class="boring">}
</span></code></pre></pre>
<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬è¿˜åªæœ‰å†…æ ¸è¿™ä¸ªæ¦‚å¿µï¼Œæ‰€ä»¥æˆ‘ä»¬åªæ˜¯å®ç°ä¸€ä¸ªå†…æ ¸çš„ç²¾ç»†æ˜ å°„æ¥ä»£æ›¿å¼€å§‹çš„æ—¶å€™ç²—ç³™çš„æƒé™ç®¡ç†ï¼ˆä¸€å¹¶æŠŠé¡µè¡¨æ¿€æ´»å®ç°ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>//os/src/memory/mapping/memory_set.rs
impl MemorySet {
    /// åˆ›å»ºå†…æ ¸é‡æ˜ å°„
    pub fn new_kernel() -&gt; MemoryResult&lt;MemorySet&gt; {
        // åœ¨ linker.ld é‡Œé¢æ ‡è®°çš„å„ä¸ªå­—æ®µçš„èµ·å§‹ç‚¹ï¼Œå‡ä¸º 4K å¯¹é½
        extern &quot;C&quot; {
            fn text_start();
            fn rodata_start();
            fn data_start();
            fn bss_start();
        }

        // å»ºç«‹å­—æ®µ
        let segments = vec![
            // .text æ®µï¼Œr-x
            Segment {
                map_type: MapType::Linear,
                range: Range::from((text_start as usize)..(rodata_start as usize)),
                flags: Flags::READABLE | Flags::EXECUTABLE,
            },
            // .rodata æ®µï¼Œr--
            Segment {
                map_type: MapType::Linear,
                range: Range::from((rodata_start as usize)..(data_start as usize)),
                flags: Flags::READABLE,
            },
            // .data æ®µï¼Œrw-
            Segment {
                map_type: MapType::Linear,
                range: Range::from((data_start as usize)..(bss_start as usize)),
                flags: Flags::READABLE | Flags::WRITABLE,
            },
            // .bss æ®µï¼Œrw-
            Segment {
                map_type: MapType::Linear,
                range: Range::from(VirtualAddress::from(bss_start as usize)..*KERNEL_END_ADDRESS),
                flags: Flags::READABLE | Flags::WRITABLE,
            },
            // å‰©ä½™å†…å­˜ç©ºé—´ï¼Œrw-
            Segment {
                map_type: MapType::Linear,
                range: Range::from(*KERNEL_END_ADDRESS..VirtualAddress::from(MEMORY_END_ADDRESS)),
                flags: Flags::READABLE | Flags::WRITABLE,
            },
        ];
        let mut mapping = Mapping::new()?;

        // æ¯ä¸ªå­—æ®µåœ¨é¡µè¡¨ä¸­è¿›è¡Œæ˜ å°„
        for segment in segments.iter() {
            mapping.map(segment, None)?;
        }
        Ok(MemorySet { mapping, segments })
    }

    /// æ›¿æ¢ `satp` ä»¥æ¿€æ´»é¡µè¡¨
    ///
    /// å¦‚æœå½“å‰é¡µè¡¨å°±æ˜¯è‡ªèº«ï¼Œåˆ™ä¸ä¼šæ›¿æ¢ï¼Œä½†ä»ç„¶ä¼šåˆ·æ–° TLBã€‚
    pub fn activate(&amp;self) {
        self.mapping.activate()
    }
    
    /// æ·»åŠ ä¸€ä¸ª [`Segment`] çš„å†…å­˜æ˜ å°„
    pub fn add_segment(&amp;mut self, segment: Segment, init_data: Option&lt;&amp;[u8]&gt;) -&gt; MemoryResult&lt;()&gt; {
        // æ£€æµ‹ segment æ²¡æœ‰é‡åˆ
        assert!(!self.overlap_with(segment.page_range()));
        // æ˜ å°„å¹¶å°†æ–°åˆ†é…çš„é¡µé¢ä¿å­˜ä¸‹æ¥
        self.mapping.map(&amp;segment, init_data)?;
        self.segments.push(segment);
        Ok(())
    }

    /// ç§»é™¤ä¸€ä¸ª [`Segment`] çš„å†…å­˜æ˜ å°„
    ///
    /// `segment` å¿…é¡»å·²ç»æ˜ å°„
    pub fn remove_segment(&amp;mut self, segment: &amp;Segment) -&gt; MemoryResult&lt;()&gt; {
        // æ‰¾åˆ°å¯¹åº”çš„ segment
        let segment_index = self
            .segments
            .iter()
            .position(|s| s == segment)
            .expect(&quot;segment to remove cannot be found&quot;);
        self.segments.remove(segment_index);
        // ç§»é™¤æ˜ å°„
        self.mapping.unmap(segment);
        Ok(())
    }

    /// æ£€æµ‹ä¸€æ®µå†…å­˜åŒºåŸŸå’Œå·²æœ‰çš„æ˜¯å¦å­˜åœ¨é‡å åŒºåŸŸ
    pub fn overlap_with(&amp;self, range: Range&lt;VirtualPageNumber&gt;) -&gt; bool {
        for seg in self.segments.iter() {
            if range.overlap_with(&amp;seg.page_range()) {
                return true;
            }
        }
        false
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å®Œæ•´å®ç°äº†å†…æ ¸çš„é‡æ˜ å°„ï¼Œè¿›è¡Œå£°æ˜ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// os/src/memory/mapping/mod.rs
//! å†…å­˜æ˜ å°„
//!
//! æ¯ä¸ªçº¿ç¨‹ä¿å­˜ä¸€ä¸ª [`Mapping`]ï¼Œå…¶ä¸­è®°å½•äº†æ‰€æœ‰çš„å­—æ®µ [`Segment`]ã€‚
//! åŒæ—¶ï¼Œä¹Ÿè¦è¿½è¸ªä¸ºé¡µè¡¨æˆ–å­—æ®µåˆ†é…çš„æ‰€æœ‰ç‰©ç†é¡µï¼Œç›®çš„æ˜¯ drop æ‰ä¹‹åå¯ä»¥å®‰å…¨é‡Šæ”¾æ‰€æœ‰èµ„æºã€‚

#[allow(clippy::module_inception)]
mod mapping;
mod memory_set;
mod page_table;
mod page_table_entry;
mod segment;

pub use mapping::Mapping;
pub use memory_set::MemorySet;
pub use page_table::{PageTable, PageTableTracker};
pub use page_table_entry::{Flags, PageTableEntry};
pub use segment::{MapType, Segment};
<span class="boring">}
</span></code></pre></pre>
<p>åœ¨memoryä¸­æ·»åŠ æ¨¡å—</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// os/src/memory/mod.rs
//! å†…å­˜ç®¡ç†æ¨¡å—
//!
//! è´Ÿè´£ç©ºé—´åˆ†é…å’Œè™šæ‹Ÿåœ°å€æ˜ å°„

// å› ä¸ºæ¨¡å—å†…åŒ…å«è®¸å¤šåŸºç¡€è®¾æ–½ç±»åˆ«ï¼Œå®ç°äº†è®¸å¤šä»¥åå¯èƒ½ä¼šç”¨åˆ°çš„å‡½æ•°ï¼Œ
// æ‰€ä»¥åœ¨æ¨¡å—èŒƒå›´å†…ä¸æç¤ºã€Œæœªä½¿ç”¨çš„å‡½æ•°ã€ç­‰è­¦å‘Š
#![allow(dead_code)]

pub mod address;
pub mod config;
pub mod frame;
pub mod heap;
pub mod mapping;
pub mod range;

/// ä¸€ä¸ªç¼©å†™ï¼Œæ¨¡å—ä¸­ä¸€äº›å‡½æ•°ä¼šä½¿ç”¨
pub type MemoryResult&lt;T&gt; = Result&lt;T, &amp;'static str&gt;;

pub use {
    address::*,
    config::*,
    frame::FRAME_ALLOCATOR,
    mapping::{Flags, MapType, MemorySet, Segment},
    range::Range,
};

/// åˆå§‹åŒ–å†…å­˜ç›¸å…³çš„å­æ¨¡å—
///
/// - [`heap::init`]
pub fn init() {
    heap::init();
    // å…è®¸å†…æ ¸è¯»å†™ç”¨æˆ·æ€å†…å­˜
    unsafe { riscv::register::sstatus::set_sum() };

    println!(&quot;mod memory initialized&quot;);
}
<span class="boring">}
</span></code></pre></pre>
<p>åœ¨ä¸»å‡½æ•°ä¸­æµ‹è¯•ä¸€ä¸‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>//os/src/main.rs
/// Rust çš„å…¥å£å‡½æ•°
///
/// åœ¨ `_start` ä¸ºæˆ‘ä»¬è¿›è¡Œäº†ä¸€ç³»åˆ—å‡†å¤‡ä¹‹åï¼Œè¿™æ˜¯ç¬¬ä¸€ä¸ªè¢«è°ƒç”¨çš„ Rust å‡½æ•°
#[no_mangle]
pub extern &quot;C&quot; fn rust_main() -&gt; ! {
    // åˆå§‹åŒ–å„ç§æ¨¡å—
    interrupt::init();
    memory::init();

    println!(&quot;Hello rCore-Tutorial!&quot;);
    //å¼€å§‹å†…æ ¸é‡æ˜ å°„
    let remap = memory::mapping::MemorySet::new_kernel().unwrap();
    //æ¿€æ´»
    remap.activate();

    println!(&quot;å†…æ ¸é‡æ˜ å°„æˆåŠŸ&quot;);

    panic!()
}
<span class="boring">}
</span></code></pre></pre>
<p>åœ¨è¿™é‡Œæˆ‘ä»¬ç”³è¯·äº†ä¸€ä¸ªå†…æ ¸çš„é‡æ˜ å°„ï¼Œç„¶åå¯¹é¡µè¡¨è¿›è¡Œæ¿€æ´»ï¼Œåé¢è¿è¡Œäº†ä¸€å¥è¾“å‡ºï¼Œè™½ç„¶çœ‹èµ·æ¥æ²¡æœ‰ä»€ä¹ˆä¸åŒï¼Œåªæ˜¯è¾“å‡ºäº†ä¸€å¥è¯ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„åˆ°è¿™å¥è¯æ‰€ç”¨çš„æ‰€æœ‰é€»è¾‘å·²ç»å»ºç«‹åœ¨äº†æ–°æ„å»ºçš„é¡µè¡¨ä¸Šï¼Œè€Œä¸æ˜¯é‚£ä¸ªç²—ç³™çš„ <code>boot_page_table</code> äº†ã€‚<code>boot_page_table</code> å¹¶éæ²¡æœ‰ç”¨ï¼Œå®ƒä¸ºæˆ‘ä»¬æ„å»ºé‡æ˜ å°„æä¾›äº†æ”¯æŒï¼Œä½†ç»ˆç©¶æˆ‘ä»¬ä¼šç”¨æ›´ç²¾ç»†çš„é¡µè¡¨å’Œæ˜ å°„ä»£æ›¿äº†å®ƒï¼Œå®ç°äº†æ›´ç»†è‡´çš„ç®¡ç†å’Œå®‰å…¨æ€§ã€‚</p>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å®ç°äº†é‡æ˜ å°„ï¼Œè€Œåœ¨ä¸Šé¢æˆ‘ä»¬ä¹Ÿåªæ˜¯ç”¨ä¸€ä¸ªå±€éƒ¨å˜é‡æ¥è°ƒç”¨äº†ç®€å•æµ‹è¯•äº†è¿™ä¸ªæ˜ å°„ï¼Œè€Œå®é™…ä¸Šï¼Œåé¢æˆ‘ä»¬ä¼šæŠŠå…¨éƒ¨è¿è¡Œçš„é€»è¾‘éƒ½å°è£…ä¸ºçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å°†ä¼šæœ‰ä¸€ä¸ª <code>MemorySet</code> å¹¶å­˜åœ¨äºä¸€ä¸ªçº¿ç¨‹çš„ç»“æ„ä¸­è€Œä¸æ˜¯ä¸€ä¸ªç®€å•çš„å±€éƒ¨å˜é‡ã€‚å½“çº¿ç¨‹é”€æ¯çš„æ—¶å€™ï¼Œçº¿ç¨‹ä¸­å…¨éƒ¨ä½¿ç”¨çš„é€»è¾‘ï¼ˆåŒ…æ‹¬é¡µè¡¨æ‰€åœ¨çš„ç‰©ç†é¡µå’Œå…¶ä»–ç”³è¯·çš„ç‰©ç†é¡µç­‰ï¼‰å°†ä¼šè¢«ä¹‹å‰è®¾è®¡çš„ Tracker æœºåˆ¶è‡ªåŠ¨é‡Šæ”¾ã€‚</p>
<p>ä¸å¾—ä¸è¯´ï¼Œç”¨ Rust å†™è¿™äº›å†…å®¹æ˜¯ç—›è‹¦çš„ï¼ˆå¯èƒ½åé¢ä¸€ä¸¤ä¸ªç« èŠ‚è¿˜ä¼šç—›è‹¦ä¸€æ®µæ—¶é—´ï¼‰ï¼Œä½†æ˜¯ä¸ºäº†å……åˆ†å‘æŒ¥ Rust çš„ç‰¹æ€§ï¼Œè¿™äº›æŒ£æ‰æ˜¯å¿…è¦çš„ï¼Œä¸€æ—¦æˆ‘ä»¬é“ºå¹³äº†è¿™äº›åŸºç¡€è®¾æ–½ï¼Œåé¢çš„æµç¨‹ä¼šå¤§å¤§ç®€åŒ–ã€‚å¯¹äºè¿™ä¸¤ç« çš„å†…å®¹æˆ‘ä»¬ä¹Ÿç»å†è¿‡å¤§é‡è®¨è®ºï¼Œä¹Ÿåšäº†å¤§é‡çš„è®¾è®¡æ€§å’Œæ•™å­¦æ€§æƒè¡¡ï¼Œå¦‚æœä½ é˜…è¯»æ–‡æ¡£è¿˜æ˜¯ä¸€å¤´é›¾æ°´ï¼Œå¯ä»¥å»å®Œæ•´çš„é˜…è¯»ä»£ç å’Œå¯¹åº”çš„æ³¨é‡Šå¹¶å°è¯•è¿è¡Œã€‚</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="lab3-3.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="lab3-5.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="lab3-3.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="lab3-5.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
