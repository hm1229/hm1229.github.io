# 方案解析

文件系统的主要功能是提供了一种对数据或程序进行存储和访问的机制。如果需要实现一个文件系统，那么最终的目的就要实现把数据或程序放在操作系统的存储设备上，并让操作系统来进行读取。

第一步就是让操作系统知道其挂载了哪些存储设备。在RISC-V中，bootloader会负责扫描包括物理内存在内的各种外设，将结果以设备树**二进制对象**（DTB，Device Tree Blob）的格式保存在物理内存中。进一步说，bootloader会将物理内存中放置该设备树二进制对象的物理地址存储在a1寄存器中，将HART ID （HART，Hardware Thread）存放在a0寄存器中。

仅需给主函数rust_main增加两个参数即可让其获得读取设备信息的能力。

获取到HART ID和DTB后。只需对其节点进行遍历和解析，即可得到一个完整的设备树。

现在拥有了整棵设备树，那么还应该对相应的设备来进行驱动的编写，以保证该设备能按需要的方式提供服务。

这里先抽象一个最底层的驱动，为操作系统提供抽象驱动的概念。

同时由于外部存储设备的寻址速读相较于内存比较缓慢。应将使用整块作为粒度进行读写操作来加快其读写速度，节省硬盘等设备的寻道时间。

接下来将要抽象一个块设备。这实际上是对于最底层驱动抽象的引用，作为为文件系统提供服务的接口，使文件系统调用该块设备的接口进行读写操作。

因为操作系统本身比较庞大，使用rCore中模块化的文件系统rcore-sfs（Simple File System）。经过驱动的封装后，现在只需要提供一些基础的参数，如根目录的INode（INode是对文件位置的抽象）。现在将对根目录进行初始化。具体的做法是找到全部驱动设备中的第一个存储设备作为根目录。

同时还加入了BlockCache块缓存，该模块也由rcore-fs提供，它提供了一个存储在内存Cache中的抽象，就可以把device变为一个有Cache的设备。最后只需使用open打开被动态分配作为设备Cache的内存空间即可。这样，一个文