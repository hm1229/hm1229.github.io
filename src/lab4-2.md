# 知识储备

## 进程

进程是正在运行并且使用计算机资源的程序。其作为资源分配的单位，在该系统中抽象出进程来维护页面映射来、存储用户态标识、表示访存空间，以及文件描述符等。

## 线程

根据以上的叙述完成的操作系统默认进程是只具有单个线程控制能力的一个执行程序，但几乎所有的现在操作系统都允许一个进程包括多个线程。例如一个浏览器可能有一个线程用来显示文本和图像，另线程从网络上接收数据等。线程是使用CPU的一个基本单元，包括线程ID、运行栈、线程执行上下文、所属进程的记号和内核栈等，他在于同一进程的相其他线程共享资源。

### 创建线程

当创建一个线程并将其执行时，需要准备建立一个线程的抽象。在此抽象中实现页表映射、设置起始执行地址、各种寄存器和一些执行参数。

### 切换线程

线程在切换之前，系统首先会引发中断。中断会保存上一个线程的Context，然后。将下一个线程的Context恢复进入。这需要对中断的处理函数进行一些修改以使其满足以上功能。同时线程有可能由用户线程切换到内核线程。这种跨特权级的切换会导致Context无法保存，同时还应在维护一个内核栈来保存必要的寄存器。

### 结束线程

当线程执行到函数末尾会引发缺页中断，本文的解决方式是使线程将自己标记为已结束，同时触发一个普通的断点，这时操作系统会观察到线程标记，并将其终止。

### 实现线程调度

实现一个使用高响应比优先调度算法的调度器。使用这种算法，既考虑到了执行时间，也考虑到了其他作业的等待时间。这种算法是结合了先来先服务和最短作业优先两种算法优点的折中算法。

从**源代码**经过编译器一系列处理（编译、链接、优化等）得到的可执行文件，我们称为**程序（Program）**。而通俗地说，**进程（Process）**就是**正在运行**并**使用计算机资源**的程序，与放在磁盘中一动不动的程序不同：首先，进程得到了操作系统提供的**资源**：程序的代码、数据段被加载到**内存**中，程序所需的虚拟内存空间被真正构建出来。同时操作系统还给进程分配了程序所要求的各种**其他资源**，如我们上面几个章节中提到过的页表、文件的资源。

然而如果仅此而已，进程还尚未体现出其“**正在运行**”的动态特性。而正在运行意味着 **CPU** 要去执行程序代码段中的代码，为了能够进行函数调用，我们还需要**运行栈（Stack）**。

出于OS对计算机系统精细管理的目的，我们通常将“正在运行”的动态特性从进程中剥离出来，这样的一个借助 CPU 和栈的执行流，我们称之为**线程 (Thread)** 。一个进程可以有多个线程，也可以如传统进程一样只有一个线程。

这样，进程虽然仍是代表一个正在运行的程序，但是其主要功能是作为**资源的分配单位**，管理页表、文件、网络等资源。而一个进程的多个线程则共享这些资源，专注于执行，从而作为**执行的调度单位**。举一个例子，为了分配给进程一段内存，我们把一整个页表交给进程，而出于某些目的（比如为了加速需要两个线程放在两个 CPU 的核上），我们需要线程的概念来进一步细化执行的方式，这时进程内部的全部这些线程看到的就是同样的页表，看到的也是相同的地址。但是需要注意的是，这些线程为了可以独立运行，有自己的栈（会放在相同地址空间的不同位置），CPU 也会以它们这些线程为一个基本调度单位。