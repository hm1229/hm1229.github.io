# rCore_Tutorial_Detail

## 比赛准备和调研

​       随着计算机的发展，计算设备由大型的超级计算机到普通的家用电脑，再到分布式的各种智能硬件，设备的大小越来越趋近于微型化。对于计算机上所承载的程序的开发，也由最初的机器语言，逐渐发展到了过程描述语言、面向对象语言。语言的不断抽象，在客观上降低了开发人员的开发难度，但却需要相比于低级语言更多的操作系统性能开销。且由于近年来摩尔定律几近失效，芯片性能增长放缓，使得设备的日益小型化的需要与程序设计语言的高度抽象化趋势之间的矛盾逐渐凸显。

​       目前的小型设备基本以运行不依托操作系统的简单程序为主，由于性能的限制无法构建完整的系统内核，并不能很好地支持高度抽象的编程语言，导致其普遍抽象程度不高，而且因为没有操作系统的支持，程序的运行很不稳定。目前小型设备亟需一个性能开销小、运行稳定的操作系统内核。

​       Rust语言作为一种高效、可靠的通用高级语言，拥有极高的性能，具有优秀的底层控制能力以及编译期计算能力，同时还保证了线程安全，可以轻松的集成其他语言，有较为完备的文档以及错误提示。由于其快速、跨平台、低资源占用的优点，十分适合作为操作系统内核的开发语言。对于Rust语言编写操作系统内核的可行性的研究，有助于拓展Rust语言对于嵌入式设备的应用场景，为将Rust语言的特性引入操作系统内核的研究打下基础。

​       经过对于国内外文献的查阅，发现目前对于操作系统内核的研究多集中在X86指令集架构的复杂内核，对于RISC-V精简指令集的研究基本集中在机器学习领域，而且由于资源受限多使用容器化技术来模拟Linux系统进行相关机器学习代码的实现，造成了额外的开销。

​      这一研究可以弥补计算机学界对RISC-V指令集架构操作系统内核研究的不足，并影响基于RISC-V的机器学习的研究。对于在运行资源较低的设备上构建操作系统内核的可行性的研究，有助于使小型化甚至微型设备更具智能性和拓展性。

​      同时相较于宏内核的复杂架构，较为简单的操作系统内核有助于帮助开发人员在底层逻辑上理解操作系统的调度方式。对高等院校操作系统课的教授方法也有一定的启示。



 

## 系统框架和模块设计

实验的目的是使用Rust语言去实现一个基于RISC-V架构的操作系统内核，利用Rust语言的关键特性使得操作系统内核具备线程安全的特性。该操作系统内核是一个具备了操作系统基础的核心机制的微内核，基于负责与硬件通信的SBI，包括引导程序、内核加载器bootloader、中断、内存、进程、线程、文件系统等模块。

实验首先对相关研究现状进行了分析，对于Rust语言、RISC-V架构及其汇编语言进行简要介绍；自上而下对阐述了整个内核架构的设计方案，在技术路线中给出了操作系统内和各个模块之间的关系与实现思路；然后对于操作系统内核进行了自下而上的实现，并给出了关键代码及其解释，最后经过细化的系统测试，验证功能的正确性。

实验基于Ubuntu操作系统和Rust工具链作为开发环境，使用Rust语言以及RISC-V架构的汇编语言的混合编程进行开发，利用QEMU虚拟机进行调试和测试所实现的操作系统内核功能。

 

| **实验编号** | **实验名称**  | **主要内容**                                                 |
| ------------ | ------------- | ------------------------------------------------------------ |
| 0            | RV64 裸机应用 | 创建不依赖标准库的裸机应用，为开发操作系统内核打下基础       |
| 1            | 中断处理      | 实现可以中断响应的机制，使得操作系统能够响应cpu和内存以外的中断 |
| 2            | 物理内存      | 实现物理内存的动态分配，实现物理页表                         |
| 3            | 虚拟内存      | 实现从物理内存到虚拟内存到映射，实现内核重映射               |
| 4            | 进程与线程    | 实现线程的创建、切换与结束，实现内核栈，实现线程的调度       |
| 5            | 文件系统      | 在抽象出驱动的基础上，将块设备托管给文件系统                 |
| 6            | 用户进程      | 实现用户进程的创建与运行                                     |
| 7            | 性能监控      | 构建用户态性能监控程序，做到实时对进程信息的监控             |

 



 

## 开发计划

要实现一个能支持多道程序处理能力的操作系统系统，那么就需要为多道程序的运行提供必要资源。一般来说，单个程序并不会占用CPU和I/O的全部资源，单个用户会同时运行多个程序。使用进程模块可以进程的切换，从而提高CPU的利用率。同时为了满足安全要求，应隔离每一个进程，为其开辟属于自己的虚拟内存空间，这一部分由内存模块负责。

进程的切换需要终止当前的进程，保存当前的状态，从内存或是外存中加载新的程序作为进程。这就需要中断模块来进行进程上下文的保存于恢复，以及中断处理。实际上，现代操作系统是中断驱动的。如果没有用户需要响应、没有进程需要执行，没有I/O设备需要服务，那么操作系统会等待这些事件的发生。事件总是由中断引起的，而中断又分为不同的类型，如软件产生了中断、运行时出现的错误或用户程序的请求。对于每一种中断操作系统都会有相应的操作进行处理。这就需要中断模块的配合。

操作系统会在内存中同时存储多个进程的堆栈数据，但由于内存空间有限，不能容纳所有的数据。所以需要将部分不必要的数据存储在磁盘中，在需要的时候通过内存模块的页表将进程使用的资源动态地加载到内存中。

操作系统必须保证足够的响应时间，这可以通过内核模块的页表进行虚拟内存映射来实现。这样做的好处是，一个运行中的进程无需全部加载至内存中，也就是在一定程度上用户可以运行比内存空间大的程序。同时，虚拟内存将物理内存和 逻辑内存区分开，使开发人员不必受内存空间的束缚。

计算机需要在多种类型的介质中存储信息。每种存储介质都有其不同的特点。如访问速度、容量传输速度、访问方法等。文件是文件创建者定义的相关信息集合。通过文件系统，操作系统可以管理各种存储介质，并控制它们来实现文件这一概念。同时将文件组织成目录。当多个用户访问时，操作系统负责控制不同用户对不同文件的访问权限。

综上，本文设计的操作系统内核的整体架构如图。

![image-20210818230048005](C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20210818230048005.png)



 

## 开发过程

###  总体目标

- 添加细节，加入更多的代码注释
- 改变文章逻辑，使其成为任务驱动。具体框架为：实验目的、知识储备、方案解析、实验步骤、小节
- 添加性能分析

### 任务计划

 路博雅：7.3-7.18  完成Rust与Lab的基本学习

​                7.19-7.21  将lab移植到git book上面

​                7.22-7.31  学习新加的代码，继续更改lab逻辑

彭淳毅：7.8-7.31 学习v3并添加入原始文档

​               8.5-8.15  添加lab7性能监控  

## 遇到的主要问题和解决方法 

首先，作为大一、大二的学生，对于计算机操作系统等的专业知识的匮乏，所以对于实验内容：使用Rust语言去实现一个基于RISC-V架构的操作系统内核的概念以及实操都是未知的。经过查阅资料和听一些网课，包括但不限于清华大学向勇老师、陈渝老师在学堂在线上发布的网课[（操作系统RISC-V）](https://www.xuetangx.com/learn/thu08091002729/thu08091002729/5883981/video/9244851)、于gitbook上发布的[《rCore-Tutorial-Book-v》](http://wyfcyx.gitee.io/rcore-tutorial-book-v3/chapter0/index.html)、Rust语法[（中文）](https://kaisery.github.io/trpl-zh-cn/ch01-02-hello-world.html)有的地方翻译的不确切还会查找原文档[（英文）](https://doc.rust-lang.org/nightly/std/index.html)…经过学习并且遇到难以理解的地方时，我们还会向赵霞老师进行请教。

其次，除了专业知识，在我们对原文档进行复现的时候，我们发现[原文档](https://rcore-os.github.io/rCore-Tutorial-deploy/notes/log.html)中逻辑以及代码存在着很大的问题，非常不适合刚接触计算机操作系统的“小白”进行上手实操。我们第一步做的是依照原文档进行复现，经过复现对原文档的步骤代码等原文档中写的较为模糊笼统的地方进行详细化、准确化更改确保后面使用该文档的同学可以按步骤进行复现。

最后，虽然我们在自己第一遍做实验的时候进行了完整的复现，但是有的时候，我们并不清楚这个步骤的意义原理是什么。经过更深度的思考和知识补充，我们对文档进行逻辑整理和进行思路上的细化，添加相应的知识点，使得文档更具有逻辑性；在必要的地画流程图和思维导图，使得文档在深度和广度上都有知识上的连贯性。让同学们在做实验的时候不仅可以依据步骤完成实验更能明白其中的原理。



 

## 作品特征描述

1.对代码有详细的注释。

eg.

![image-20210818230318747](C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20210818230318747.png)

![image-20210818230330564](C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20210818230330564.png)

2.对每个实验步骤都有实验原理说明。

eg. 

![image-20210818230305260](C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20210818230305260.png)



3.实验结束有输出结果展示，便于自查

eg.

![image-20210818230250813](C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20210818230250813.png)

4．八个实验都有固定的排版模式，便于学习

eg.

![image-20210818230222121](C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20210818230222121.png)



 

## 分工和协作

组内两位同学：彭淳毅、路博雅。

彭淳毅进行对原文档的复现。由于实验要求，所以两位同学都需要自己做完整个过程，彭淳毅先进行完成，所以路博雅在复现的时候有疑问，可以互相讨论以及向老师进行询问。两人同时进行对原文档内容的细节增加。然后，由路博雅对原文档的逻辑进行整理并添加知识导图，彭淳毅添加性能分析等新内容。最后，彭淳毅负责做答辩视频，路博雅负责编写文档。

 

## 比赛收获

对操作系统内核的设计有了更全面的认识。意识到在自己学操作系统知识的时候，过于偏向理论层面，而缺少了实际的动手能力，这次比赛也是提醒了我们“纸上得来终觉浅。绝知此事要躬行。”。在学习的过程中，如果仅仅学习理论知识是不足的，动手实操可以深化我们的知识体系，巩固我们的理论认知，有助于我们对知识进行更全面的理解。



|      |      |      |      |
| :--: | :--: | ---- | ---- |
|      |      |      |      |
|      |      |      |      |
|      |      |      |      |
|      |      |      |      |
|      |      |      |      |
|      |      |      |      |
|      |      |      |      |